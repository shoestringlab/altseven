function Constructor(t,e,s){var i;return!0===s&&EventBindings.getAll().forEach(function(e){void 0===t.prototype[e]&&(t.prototype[e.name]=e.func)}),i=Object.create(t.prototype),!0===s&&(i.events={},void 0!==t.prototype.events)&&t.prototype.events.forEach(function(e){i.events[e]=[]}),s=void 0===(s=t.apply(i,e))?i:s}var EventBindings={on:function(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this},off:function(e){return this.events[e]=[],this},fireEvent:function(e,t){var s=this;void 0!==this.events[e]&&this.events[e].forEach(function(e){e(s,t)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};class Component{constructor(){this.events={}}on(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this}off(e){return this.events[e]=[],this}fireEvent(e,t){void 0!==this.events[e]&&this.events[e].forEach(e=>{e(this,t)})}getAll(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}}class DataProvider extends Component{#state={};#schema;constructor(e){super(),this.binding=e?.binding,this.#state=e.state,this.#schema=e.schema,this.view=e.view,this.id=this.view.props.id+"-dataProvider",this.services=new Map,this.bindings=new Map}set schema(e){}get schema(){return this.#schema}setStateOnly(e){this.#state=Object.assign(this.#state,e)}setState(e){this.setStateOnly(e),this.fireEvent("stateChanged",e)}getState(){return Object.assign({},this.#state)}}class Entity extends Component{#schema;#data;constructor(e){if(super(),this.#schema=e.schema,this.#data={},this.#schema&&this.validate())for(var[t,s]of Object.entries(this.#schema))this._defineProperty(t),this[t]=e[t]}_defineProperty(i){let r="_"+i;this.#data[r]=void 0,Object.defineProperty(this,i,{get:function(){return this.#data[r]},set:function(e){var t=this.#schema[i];if(t.required&&void 0===e)throw new Error(`Property ${i} is required.`);var t=t.type,s=typeof e;if(!this._isOfType(e,t)&&null!=e)throw new Error(`Invalid type for property ${i}. Expected ${t}, but got ${s}.`);this.#data[r]=e}})}_isOfType(e,t){switch(t){case"date":return new Date(e)instanceof Date;case"array":return Array.isArray(e);case"boolean":return 0===e||1===e||!0===e||!1===e;case"integer":return Number.isInteger(e);case"float":return"number"==typeof e;case"string":return"string"==typeof e;default:return!0}}set schema(e){}get schema(){return this.#schema}validate(){for(var e in this.#schema){if(e.required&&!this.#data[e])throw new Error(`Field ${e} is required`);if(e.type&&typeof this.#data[e]!==e.type)throw new Error(`Field ${e} must be of type `+e.type)}return!0}}let Model=(()=>{let o=new Map,i=new Map,s=20,a;class r{constructor(e,t){this.data=this.processValue(e),this.elements=[],this.mementos=[],this.currentMementoIndex=-1,t&&this.bind(t),this.saveMemento()}handleEvent(e){if("change"===e.type){e.originalSource??="BindableObject.handleEvent[change]";for(var{elem:t,prop:s}of this.elements){var i;e.target.name===s&&"BindableObject.updateDomElement"!==e.originalSource&&(i=e.target.type.includes("select")?{id:e.target.value,text:e.target.options[e.target.selectedIndex].textContent}:e.target.value,this.change(i,e,s))}}}change(e,s,i){s.originalSource??="BindableObject.change",a.trace("change : Source: "+s.originalSource);let t=this.processValue(e);if(i){if("object"!=typeof this.data||null===this.data)throw new Error("Attempt to treat a simple value as an object with properties.");if(!(i in this.data))throw new Error(`Property '${i}' of object is undefined.`);this.data[i]=t}else this.data=t;this.saveMemento(),this.elements.filter(({prop:e,elem:t})=>(!i||i===e)&&t!==s.target).forEach(({elem:e})=>this.updateDomElement(s,e,t))}updateDom(s,i,r){s.originalSource??="BindableObject.updateDom",this.elements.forEach(({elem:e,prop:t})=>{r?t===r&&this.updateDomElement(s,e,i):"object"==typeof i&&null!==i?t in i&&this.updateDomElement(s,e,i[t]):this.updateDomElement(s,e,i)})}updateDomElement(e,i,t){e.originalSource??="BindableObject.updateDomElement";var s=()=>{i.innerHTML="";var e=Array.isArray(t)?t:t instanceof Map?Array.from(t.entries()):[t];"SELECT"===i.tagName?e.forEach((e,t)=>{var s=document.createElement("option");s.value="object"==typeof e?e.id??e[0]:e,s.textContent="object"==typeof e?e.text??e[1]:e,i.appendChild(s)}):["UL","OL"].includes(i.tagName)&&e.forEach(e=>{var t=document.createElement("li");t.textContent="object"==typeof e?e.text??e[1]:e,i.appendChild(t)})},r=["INPUT","TEXTAREA"].includes(i.tagName),n=["OL","UL","SELECT"].includes(i.tagName),o=["DIV","SPAN","H1","H2","H3","H4","H5","H6","P","LABEL","BUTTON","A","STRONG","EM","B","I","U","SMALL","SUB","SUP","Q","BLOCKQUOTE","CITE","CODE","PRE","ABBR","DFN","SAMP","KBD","VAR","LI","DT","DD","TH","TD","CAPTION","FIGCAPTION","SUMMARY","LEGEND","TITLE"].includes(i.tagName);"object"==typeof t&&null!==t?r?i.value=t.id??(t instanceof Map?"":t[0])??"":n?s():o&&(i.textContent=t.text??(t instanceof Map?"":t[1])??""):r?i.value=t??"":n?s():o&&(i.textContent=t??""),"model.set"!==e.originalSource&&"memento.restore"!==e.originalSource&&i.dispatchEvent(new Event("change",{originalSource:"model.updateDomElement"}))}bind(e,t){var s={elem:e,prop:t||""};e.value=t?this.data[t]:this.data,e.addEventListener("change",this),this.elements.push(s)}processValue(e){switch(typeof e){case"undefined":case"number":case"boolean":case"function":case"symbol":case"string":return e;case"object":return null===e?null:e instanceof Map?new Map(e):e;default:return e}}saveMemento(){this.currentMementoIndex<this.mementos.length-1&&this.mementos.splice(this.currentMementoIndex+1);var e=this.processValue(this.data);this.mementos.push(e),this.mementos.length>s?this.mementos.shift():this.currentMementoIndex++}undo(){return 0<this.currentMementoIndex&&(this.currentMementoIndex--,this.restoreMemento(),!0)}redo(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex++,this.restoreMemento(),!0)}rewind(){return 0<this.currentMementoIndex&&(this.currentMementoIndex=0,this.restoreMemento(),!0)}fastForward(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex=this.mementos.length-1,this.restoreMemento(),!0)}restoreMemento(){this.data=this.processValue(this.mementos[this.currentMementoIndex]);let s={originalSource:"memento.restore"};this.elements.forEach(({elem:e,prop:t})=>{this.updateDomElement(s,e,t?this.data[t]:this.data)})}}return{BindableObject:r,init(e={},t){s=e.maxMementos??20,a=t},create(e,t,s){t=new r(t).processValue(t),t=new r(t,s);o.set(e,t),i.set(e,t)},destroy(e){o.delete(e),i.delete(e)},bind(e,t){var[e,s]=e.split("."),e=o.get(e);e&&e.bind(t,s)},exists(e){return o.has(e)},get(e,t){if(e){var[e,s]=e.split("."),i=o.get(e);if(i){if(!t)return(s=s?i.data[s]:i.data)instanceof Map?new Map(s):s;if(i.data instanceof Map){if(i.data.has(t))return i.data.get(t);a.error(`Key '${t}' does not exist in the Map .`)}}else a.error(`Key '${e}' does not exist in the model.`)}else a.error("Expected parameter [name] is not defined.")},set(e,t){if(e){var[e,s]=e.split("."),i={originalSource:"model.set"};if(o.has(e)){var r=o.get(e),n=r.processValue(t);r.change(n,i,s),r.updateDom(i,n,s)}else{if(s)throw new Error(`Object ${e} is not yet initialized.`);this.create(e,t)}}else a.error("Expected parameter [name] is not defined.")},undo(e){e=i.get(e);return!!e&&e.undo()},redo(e){e=i.get(e);return!!e&&e.redo()},rewind(e){e=i.get(e);return!!e&&e.rewind()},fastForward(e){e=i.get(e);return!!e&&e.fastForward()}}})();class Service extends Component{constructor(e){super(),this.id=e.id,this.key=e.key,this.remoteMethods=e.remoteMethods,this.entityClass=e.entityClass,this.dataProviders=new Map,this.bindings=new Map,this.log,this.model,this.remote,this.queue=new Map,this.config(),this.fireEvent("mustRegister")}config(){var e=this.get();e&&e instanceof Map||this.set(new Map)}set log(e){this.log=e}set model(e){this.model=e}set remote(e){this.remote=e}registerDataProvider(e){this.dataProviders.set(e.id,e),e.log=this.log}convertArrayToMap(e){let t=new Map;return e.forEach(e=>{e[this.key]&&t.set(e[this.key],e)}),t}convertMapToArray(e){return Array.from(e.values())}compareIDs(e){this.log.trace("Service: "+this.id),this.log.trace("compareIDs: "+e);let t=this.get(),s=[],i=[];return t instanceof Map?(e.forEach(e=>{(t.has(e)?s:i).push(e)}),this.log.trace("results: "+JSON.stringify(s)+" "+JSON.stringify(i)),{present:s,missing:i}):{present:s,missing:e}}merge(e){let t=this.get();return t instanceof Map||(t=new Map),e.forEach(e=>{e[this.key]&&t.set(e[this.key],this.format(e))}),this.set(t),this.fireEvent("cacheChanged",{action:"refresh"}),t}bind(e,t){this.bindings.set(e,{filter:t})}async create(e){let t=!e instanceof this.entityClass?this.format(e):e;return await this.remote.invoke(this.remoteMethods.create,t).then(e=>e.json()).then(e=>{t=this.format(e),this.cacheSet(t)}),t}async read(e){let s=this.get();var i=this.remoteMethods.read+"-"+JSON.stringify(e);if(this.queue.has(i))this.log.trace("Duplicate read request detected, cancelling new request");else if(!s.has(e[this.key])){let t;await this.remote.invoke(this.remoteMethods.read,e).then(e=>e.json()).then(e=>{t=e}),this.cacheSet(this.format(t)),this.queue.delete(i),s=this.get()}return s.get(e[this.key])}async update(e){let t=this.format(e);return await this.remote.invoke(this.remoteMethods.update,e).then(e=>e.json()).then(e=>{t=this.format(e),this.cacheSet(t)}),t}async delete(e){return await this.remote.invoke(this.remoteMethods.delete,e).then(e=>e.json()).then(e=>{}),this.cacheDelete(e[this.key]),!0}async readAll(e){var s=this.remoteMethods.readAll+"-"+JSON.stringify(e);if(this.queue.has(s))this.log.trace("Duplicate read request detected, cancelling new request");else if(!this.get().size){let t;await this.remote.invoke(this.remoteMethods.readAll,e).then(e=>e.json()).then(e=>{t=e}),this.merge(t),this.queue.delete(s)}return this.get()}format(e){return new this.entityClass(e)}cacheDelete(e){var t=this.get();t.delete(e),this.set(t),this.fireEvent("cacheChanged",{action:"delete"})}cacheSet(e){if(!(e instanceof this.entityClass))throw"Item must be of proper entity type.";var t=this.get();t.set(e[this.key],e),this.set(t),this.fireEvent("cacheChanged",{action:"refresh"})}set(e){this.model.set(this.id,e)}get(e){return void 0===e?this.model.get(this.id):this.model.get(this.id,e)}async readMany(e){if(void 0===e)return new Map;this.log.trace("readMany: ");let t=this.remoteMethods.readMany+"-"+JSON.stringify(e);var s,i;return this.queue.has(t)?this.log.trace("Duplicate read request detected, cancelling new request"):({present:s,missing:i}=this.compareIDs(e),this.log.trace("Missing? "+i.length),0<i.length&&await this.remote.invoke(this.remoteMethods.readMany,{id:i}).then(e=>e.json()).then(e=>{Array.isArray(e)&&(this.merge(e),this.queue.delete(t))})),e.map(e=>this.get(e)||null).filter(e=>null!==e)}sort(e,o){e=e instanceof Map?Array.from(e.values()):e;if(o&&"object"==typeof o&&0!==Object.keys(o).length)return e.sort((e,t)=>{for(var s of Object.keys(o)){var i=o[s]||"asc",r=e[s],n=t[s];if(void 0!==r&&void 0!==n){if(typeof r!=typeof n)throw new Error(`Inconsistent types for sorting field '${s}'`);if("string"==typeof r)return s=r.localeCompare(n),"asc"===i?s:-s;if(r<n)return"asc"===i?-1:1;if(n<r)return"asc"===i?1:-1}}return 0}),e;throw new Error("Invalid sort fields provided")}filter(e,a){e=Array.isArray(e)?e:Array.from(e.values());if(!a||"object"!=typeof a||0===Object.keys(a).length)throw new Error("Invalid filter criteria provided");let h=(e,t,s)=>{switch(s){case"=":return e===t;case"!=":return e!==t;case">":return t<e;case"<":return e<t;case">=":return t<=e;case"<=":return e<=t;case"∈":case"in":return Array.isArray(t)&&t.includes(e);case"∉":case"not in":return Array.isArray(t)&&!t.includes(e);default:throw new Error("Invalid operator: "+s)}};return e.filter(e=>{for(var t of Object.keys(a)){var s,i,r,n,o=a[t];if(Array.isArray(o)&&3===o.length)return[s,i,r]=o,n=e[t],i="function"==typeof i?i():i,r&&"string"==typeof i?(r=new RegExp(i),h(n.toString(),r.test(n),s)):h(n,i,s);if(Array.isArray(o)&&2===o.length)return r=o[0],"object"==typeof(n="function"==typeof o[1]?o[1]():o[1])&&Array.isArray(n)?((e,t)=>{if(Array.isArray(t)&&2===t.length)return e>=t[0]&&e<=t[1];throw new Error("Range must be an array with two elements")})(e[t],n):h(e[t],n,r);throw new Error("Invalid criterion for field: "+t)}return!0})}}class User extends Component{constructor(e){super(),Object.assign(this,e)}getMemento(){let t={},s=this;return Object.keys(this).forEach(e=>{t[e]=s[e]}),t}}class View extends Component{constructor(e){super(),this.type="View",this.timeout,this.timer,this.element,this.props=e,this.log,this.model,this.ui,this.isTransient=e.isTransient||!1,this.state={},this.skipRender=!1,this.children={},this.components={},this.config(),this.fireEvent("mustRegister")}setLog(e){this.log=e}setModel(e){this.model=e}setUI(e){this.ui=e}config(){this.on("mustRender",this.debounce(function(){this.renderer=this.model.get("a7").ui.renderer,this.log.trace("mustRender: "+this.props.id),this.shouldRender()?this.ui.enqueueForRender(this.props.id):(this.log.trace("Render cancelled: "+this.props.id),this.skipRender=!1)}.bind(this)),18,!0),this.on("rendered",function(){this.isTransient&&(void 0!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.checkRenderStatus.bind(this),6e5)),this.onRendered()}.bind(this)),this.on("registered",function(){void 0!==this.props.parentID&&!this.mustRender||this.fireEvent("mustRender")}.bind(this)),this.on("mustUnregister",function(){this.ui.unregister(this.props.id)}.bind(this))}setState(e){this.dataProvider?this.dataProvider.setState(e):(this.state=Object.assign(e),this.fireEvent("stateChanged",e)),this.fireEvent("mustRender")}getState(){return this.dataProvider?this.dataProvider.getState():Object.assign(this.state)}registerDataProvider(e){this.dataProvider=e,this.dataProvider.on("stateChanged",(e,t)=>{this.fireEvent("stateChanged",t)})}unregisterDataProvider(){this.dataProvider=null}addChild(e){this.children[e.props.id]=e}removeChild(e){delete this.children[e.props.id]}clearChildren(){this.children={}}getParent(){return this.props.parentID?this.ui.getView(this.props.parentID):void 0}render(){var t;this.log.trace("render: "+this.props.id),null==this.element&&(this.element=document.querySelector(this.props.selector)),this.element?(this.element.innerHTML="function"==typeof this.template?this.template():this.template,t=[],this.ui.getEvents().forEach(function(e){t.push("[data-on"+e+"]")}),this.element.querySelectorAll(t.toString()).forEach(function(e){for(var t=0;t<e.attributes.length;t++){var s=e.attributes[t];s.name.startsWith("data-on")&&(s=s.name.substring(7,s.name.length),e.addEventListener(s,this.eventHandlers[e.attributes["data-on"+s].value]))}}.bind(this)),this.element.querySelectorAll("[data-bind]").forEach(function(e){this.model.bind(e.attributes["data-bind"].value,e)}),this.fireEvent("rendered")):(this.log.error("The DOM element for view "+this.props.id+" was not found. The view will be removed and unregistered."),void 0!==this.props.parentID&&this.ui.getView(this.props.parentID).removeChild(this),this.fireEvent("mustUnregister"))}shouldRender(){return!this.skipRender}onRendered(){for(var e in this.children)this.children[e].element=document.querySelector(this.children[e].props.selector),this.children[e].render()}checkRenderStatus(){null===document.querySelector(this.props.selector)?this.ui.unregister(this.id):this.isTransient&&(this.timer=setTimeout(this.checkRenderStatus.bind(this),this.model.get("a7").ui.timeout))}debounce(i,r,n=!1){let o;return function(){let e=this,t=arguments;var s=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||i.apply(e,t)},r),s&&i.apply(e,t)}}}class Console extends Component{constructor(e){super(),this.title="Console Window",this.consoleDiv=null,this.active=!1,this.app=e,this.resolve=resolve,this.reject=reject,this.options=this.app.options.console,""===this.options.container?this.reject("You must specify a container object for the console display."):this.options.enabled?(this.active=!0,this.consoleDiv=document.createElement("div"),this.consoleDiv.setAttribute("id","a7consoleDiv"),this.consoleDiv.setAttribute("class","a7-console"),document.body.appendChild(this.consoleDiv),(e=this.app.components.Constructor(this.options.container,[this.consoleDiv,{width:this.options.width,left:this.options.left,height:this.options.height,title:this.title,top:this.options.top,enableShrink:!0,enableClose:!0}],!1)).element&&e.element.setAttribute("right",0),this.options.wsServer&&this.app.remote.webSocket(this.options.wsServer,this.handleMessage.bind(this)),this.app.console.addMessage=this.addMessage.bind(this),this.app.log.info("Console initializing..."),this.resolve()):this.reject("Console init should not be called when console option is set to false.")}addMessage(e,t,s,i){var r=document.createElement("div");r.setAttribute("class","a7-console-row-"+s),void 0!==i&&(r.innerHTML=i+": ",r.setAttribute("class",r.getAttribute("class")+" a7-console-row-"+i)),r.innerHTML+=+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+": "+e,this.consoleDiv.appendChild(r)}handleMessage(e,t){var s=0;if("history"===t.type)for(s=0;s<t.data.length;s++)this.addMessage(t.data[s].text,new Date(t.data[s].time),"websocket");else"message"===t.type?this.addMessage(t.data.text,new Date(t.data.time),"websocket"):this.app.log.error("This doesn't look like valid JSON: ",t)}}class DataProviderManager extends Component{constructor(e){super(),this.app=e,this.services=this.app.services.getAll(),this._dataproviders=new Map,this.app.log.info("DataProviderManager initialized...")}getDataProvider(e){return this._dataproviders.get(e)}getAll(){return this._dataproviders}register(t){this._dataproviders.set(t.id,t),this.bind(t),this.services.forEach(e=>{e.registerDataProvider(t)}),this.app.log.info(`DataProvider "${t.id}" registered.`)}bind(r){if(r.binding)for(let i in r.binding){var e,t,s,n,o=r.binding[i].dependencies||null,a=[...this.services.values()].find(e=>e.entityClass===r.binding[i].entityClass);a&&(this.app.log.trace("Binding: ",i),e=r.binding[i].filter||null,t=r.binding[i].func||null,n=r.binding[i].sort||null,s=r.binding[i].id||null,r.bindings.set(i,{key:i,service:a,filter:e,sort:n,func:t,dependencies:o,id:s}),a.bind(i,e),n=this.getBoundData(r.bindings.get(i)),r.setStateOnly({[i]:n}),a.on("cacheChanged",(e,t)=>{t.state=r.getState(),this.updateBoundState(r.bindings.get(i),t)})),(o=r.binding[i].dependencies||[]).forEach(e=>{let s=e.split(".");1===s.length?r.on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[s]in t&&(this.app.log.trace("updated "+s),this.updateBoundState(this.bindings.get(i),{action:"refresh",state:r.getState()}))}):2===s.length&&a7.ui.getView(s[0]).on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[s[1]]in t&&(this.app.log.trace("updated "+s[1]),this.updateBoundState(r.bindings.get(i),{action:"refresh",state:r.getState(),dependentState:e.getState()}))})})}}getBoundData(e,t){let s;e=e.schema[t.key].type;return"object"===e?s=t.service.get(t.id):"map"===e&&(s=t.service.get(),null!==t.filter&&(s=t.service.filter(s,t.filter)),null!==t.sort)&&(s=t.service.sort(s,t.sort)),s}async updateBoundState(e,t,s){let i;null!==t.func?(s=Object.assign(s,{filter:t.filter,sort:t.sort}),i="AsyncFunction"===t.func.constructor.name?await t.func(s):t.func(s),"map"===dp.schema[t.key].type&&Array.isArray(i)&&(i=t.service.convertArrayToMap(i)),dp.view.setState({[t.key]:i})):(s=this.getBoundData(t),dp.view.setState({[t.key]:s}))}}class ErrorManager extends Component{constructor(e){super(),this.app=e,window.onerror=(e,t,s,i,r)=>(this.captureError(e,t,s,i,r),!1),this.app.log.info("ErrorManager initialized...")}captureError(e,t,s,i,r){var n;-1<e.toLowerCase().indexOf("script error")?this.app.log.error("Script Error: See Browser Console for Detail"):(n=["Message: "+e,"URL: "+t,"Line: "+s,"Column: "+i,"Error object: "+JSON.stringify(r)].join(" - "),this.fireEvent("scriptError",[e,t,s,i,r]),this.app.log.error(n))}}class EventManager extends Component{constructor(e){super(),this.app=e,this.topics={},this.hasProp=this.topics.hasOwnProperty,this.subscribe("auth.login",function(e){this.app.remote.invoke("auth.login",e)}),this.subscribe("auth.logout",function(e){this.app.remote.invoke("auth.logout",e)}),this.subscribe("auth.refresh",function(e){this.app.remote.invoke("auth.refresh",e)}),this.subscribe("auth.sessionTimeout",function(){this.app.security.invalidateSession()}),this.subscribe("auth.invalidateSession",function(){this.app.security.invalidateSession()})}subscribe(e,t){this.hasProp.call(this.topics,e)||(this.topics[e]=[]);var s=this.topics[e].push(t)-1;return{remove:function(){delete this.topics[e][s]}}}publish(e,t){this.app.log.trace("event: "+e),this.hasProp.call(this.topics,e)&&this.topics[e].forEach(function(e){e(t||{})})}}class LogManager extends Component{constructor(e){super(),this.app=e,this._ready=!1,this._deferred=[],this.logLevel=this.app.options.logging.logLevel,this._toBrowserConsole=this.app.options.logging.toBrowserConsole,this._consoleEnabled=this.app.options.console.enabled,this._ready=!0,this._deferred.forEach(e=>{this.log(e.message,e.level)}),this._deferred=[],this.info("Log initializing..."),this.fireEvent("initialized")}error(e){this.log(e,"ERROR")}fatal(e){this.log(e,"FATAL")}info(e){this.log(e,"INFO")}trace(e){this.log(e,"TRACE")}warn(e){this.log(e,"WARN")}log(e,t){this._ready&&0<=this.logLevel.indexOf(t)||0<=this.logLevel.indexOf("ALL")?(this._consoleEnabled&&this.app.console.addMessage(e,new Date,"local",t),this._toBrowserConsole&&console.log(e)):this._ready||this._deferred.push({message:e,level:t})}}class ModelManager extends Component{constructor(e){if(super(),this.app=e,this._model=null,this._methods={},this.app.log.info("Model initializing... "),"string"==typeof this.app.options.model)switch(this.app.options.model){case"altseven":this._model=this.app.components.Model,this._model.init(this.app.options,this.app.log);break;case"gadgetui":this._model=gadgetui.model}else"object"==typeof this.app.options.model&&(this._model=this.app.options.model);this.app.log.trace("Model set: "+this._model),Object.keys(this._model).forEach(e=>{this._methods[e]=this._model[e]})}destroy(...e){return this._methods.destroy.apply(this._model,e)}get(...e){return this._methods.get.apply(this._model,e)}set(...e){return this._methods.set.apply(this._model,e)}exists(...e){return this._methods.exists.apply(this._model,e)}bind(...e){return this._methods.bind.apply(this._model,e)}undo(...e){return this._methods.undo.apply(this._model,e)}redo(...e){return this._methods.redo.apply(this._model,e)}rewind(...e){return this._methods.rewind.apply(this._model,e)}fastForward(...e){return this._methods.fastForward.apply(this._model,e)}}class RemoteManager extends Component{constructor(e){super(),this.connections={},this.app=e,this.options=e.options.remote&&e.options.remote.modules?e.options.remote.modules:{},this.time=new Date,this.sessionTimer,this.modules={},this.token,this.app.log.info("RemoteManager initializing... ")}setModule(e,t){this.modules[e]=t}webSocket(e,t){let s=new WebSocket(e);return s.onopen=()=>{this.app.log.info(`WebSocket connection to ${e} established.`),this.fireEvent("webSocketOpen",[s])},s.onerror=e=>{this.app.log.error("WebSocket error:",e),this.fireEvent("webSocketError",[e])},s.onclose=()=>{this.app.log.info(`WebSocket connection to ${e} closed.`),this.fireEvent("webSocketClose",[])},s.onmessage=e=>{e=JSON.parse(e.data);this.app.log.trace("Received message:",e),t(e),this.fireEvent("webSocketMessage",[e])},this.connections[e]=s}getConnection(e){return this.connections[e]}closeConnection(e){this.connections[e]&&(this.connections[e].close(),delete this.connections[e],this.app.log.info(`WebSocket connection to ${e} closed.`))}closeAllConnections(){for(var e in this.connections)this.closeConnection(e)}refreshClientSession(){new Promise(function(e,t){this.app.remote.invoke("auth.refresh",{resolve:e,reject:t})}).then(function(e){e.authenticated&&this.app.log.trace("Still logged in.")}).catch(function(e){this.app.events.publish(c)})}setToken(e){sessionStorage.token=e,this.token=e}getToken(){return this.token}invalidateToken(){this.setToken("")}getSessionTimer(){return this.sessionTimer}init(t){var e=this.app.model.get("a7").auth,e=(this.options=this.app.model.get("a7").remote,this.options.sessionTimeout=e.sessionTimeout,this.options.useTokens&&sessionStorage.token&&""!==sessionStorage.token&&(this.token=sessionStorage.token),{login:function(e){this.app.log.trace("remote call: auth.login");var t={method:"POST",headers:{Authorization:"Basic "+this.app.util.base64.encode64(e.username+":"+e.password),Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({rememberMe:e.rememberMe||!1})},t=new Request(this.options.loginURL,t);fetch(t).then(function(e){var t="X-Token"===this.options.tokenType?e.headers.get("X-Token"):e.headers.get("Access_token");return null!=t&&this.setToken(t),e.json()}).then(function(t){var s;t.success?(s=this.app.model.get("user"),Object.keys(t.user).map(function(e){s[e]=t.user[e]}),sessionStorage.user=JSON.stringify(s),this.app.model.set("user",s),void 0!==e.success&&("function"==typeof e.success?e.success(t):this.app.model.get("a7").router?this.app.router.open(e.success,t):this.app.events.publish(e.success,t))):void 0!==e.failure&&("function"==typeof e.failure?e.failure(t):this.app.model.get("a7").router?this.app.router.open(e.failure,t):this.app.events.publish(e.failure,t)),void 0!==e.callback&&e.callback(t)})},logout:function(t){this.app.log.trace("remote call: auth.logout");var e={method:"POST",headers:{Authorization:"Basic "+this.app.util.base64.encode64(t.username+":"+t.password)}},e=new Request(this.options.logoutURL,e);fetch(e).then(function(e){return e.json()}).then(function(e){e.success?(this.app.security.invalidateSession(),void 0!==t.success&&("function"==typeof t.success?t.success(e):this.app.model.get("a7").router?this.app.router.open(t.success,e):this.app.events.publish(t.success,e))):void 0!==t.failure&&("function"==typeof t.failure?t.failure(e):this.app.model.get("a7").router?this.app.router.open(t.failure,e):this.app.events.publish(t.failure,e)),void 0!==t.callback&&t.callback()})},refresh:function(t){this.app.remote.fetch(this.options.refreshURL,{},!0).then(function(e){return 401===e.status?{isauthenticated:!1}:e.json()}).then(function(e){void 0!==t.resolve&&t.resolve(e)}).catch(function(e){t.reject&&t.reject(e)})}});this.setModule("auth",e),Object.keys(t).forEach(function(e){this.setModule(e,t[e])})}fetch(e,t,s){if(this.app.log.info("fetch: "+e),s&&this.options.useTokens){var i=new Date,r=Math.abs(i-this.time);if(Math.floor(r/1e3/60)>this.options.sessionTimeout)return void this.app.events.publish("auth.sessionTimeout");null!=this.token&&(void 0===t.headers?"X-Token"===this.options.tokenType?t.headers={"X-Token":this.token}:t.headers={Authorization:"Bearer "+this.getToken()}:"X-Token"===this.options.tokenType?t.headers["X-Token"]=this.token:t.headers.Authorization="Bearer "+this.getToken()),this.time=i}return r=new Request(e,t),(i=fetch(r)).then(function(e){s&&this.options.useTokens&&(null!=(e="X-Token"===this.options.tokenType?e.headers.get("X-Token"):e.headers.get("Access_token"))?(this.setToken(e),void 0!==this.sessionTimer&&clearTimeout(this.sessionTimer),this.sessionTimer=setTimeout(this.refreshClientSession,this.options.sessionTimeout)):this.app.events.publish("auth.sessionTimeout"))}).catch(function(e){this.app.log.error(e)}),i}invoke(e,t){e=e.split(".");if(!(e.length<2))return"function"==typeof this.modules[e[0]][e[1]]?this.modules[e[0]][e[1]](t):void 0;this.app.log.error("No action specified. Valid actions are: "+Object.keys(this.modules[e[0]]).toString())}}class RouterManager extends Component{constructor(e){super(),this.app=e,this.router=new Router(routes),this.app.options.useEvents=!!this.app.options.useEvents,window.onpopstate=e=>{this.match(document.location.pathname+document.location.search)},this.app.log.info("RouterManager initialized...")}add(e,t){return this.router.add(e,t),this}find(e){return this.router.find(e)}open(e,t={}){var s=this.find(e);s&&s.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},s.params||{}),this.app.options.useEvents&&"string"==typeof s.handler?this.app.events.publish(s.handler,t):s.handler(t)):this.app.log.error("No route found for path: "+e)}match(e,t={}){var s=this.find(e);s&&s.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},s.params||{}),this.app.options.useEvents?this.app.events.publish(s.handler,t):s.handler(t)):this.app.log.error("No route found for path: "+e)}}class Router{constructor(e){this.root=this.createNode(),e&&e.forEach(e=>this.add.apply(this,e))}createNode(e={}){var{regex:e=null,param:t=null,handler:s=null}=e;return{regex:e,param:t,handler:s,children:{string:{},regex:{}}}}add(e,t){return this.parseOptim(e,t,this.root),this}parse(t,s,i){if(REGEX_START_WITH_PARAM.test(t)){var r=t.match(REGEX_MATCH_PARAM);let e=i.children.regex[r[0]];e=e||(i.children.regex[r[0]]=this.createNode({regex:r[2]?new RegExp("^"+r[2]):REGEX_PARAM_DEFAULT,param:r[1]})),r[0].length===t.length?e.handler=s:this.parse(t.slice(r[0].length),s,e)}else{r=t[0];let e=i.children.string[r];e=e||(i.children.string[r]=this.createNode()),this.parse(t.slice(1),s,e)}}parseOptim(e,t,s){var i;REGEX_INCLUDE_PARAM.test(e)?this.parse(e,t,s):(i=s.children.string[e])?i.handler=t:s.children.string[e]=this.createNode({handler:t})}find(e){return this.findOptim(e,this.root,{})}findOptim(e,t,s){var i=t.children.string[e];return i&&void 0!==i.handler?{handler:i.handler,params:s}:this.find(e,t,s)}_find(e,t,s){var i,r=t.children.string[e[0]];if(r){r=this._find(e.slice(1),r,s);if(r)return r}for(i in t.children.regex){var n=t.children.regex[i],o=e.match(n.regex);if(o){if(o[0].length===e.length&&void 0!==n.handler)return n.param&&(s[n.param]=decodeURIComponent(o[0])),{handler:n.handler,params:s};var a=this.findOptim(e.slice(o[0].length),n,s);if(a)return n.param&&(s[n.param]=decodeURIComponent(o[0])),a}}return null}}class SecurityManager extends Component{constructor(e){super(),this.app=e,this.app.log.info("Security initializing..."),this.useModel=0<this.app.options.model.length,this.userArgs=this.app.options.security.userArgs||[];e=this.getUser();this.setUser(e)}async isAuthenticated(e,t){this.app.log.info("Checking authenticated state.. ");var s=await new Promise((e,t)=>{this.app.remote.invoke("auth.refresh",{resolve:e,reject:t})});s.authenticated&&this.setUser(s.user),e(s)}invalidateSession(){clearTimeout(this.app.remote.getSessionTimer()),this.app.remote.invalidateToken();var e=new this.app.components.User(this.userArgs);this.setUser(e)}setUser(e){this.useModel&&this.app.model.set("user",e),sessionStorage.user=JSON.stringify(e)}getUser(){let t,s;var e=this.useModel?this.app.model.get("user"):null;return void 0!==e&&""!==e&&null!==e?s=e:sessionStorage.user&&""!==sessionStorage.user&&(t=JSON.parse(sessionStorage.user),s=new this.app.components.User(this.userArgs),Object.keys(t).map(e=>s[e]=t[e])),s}}class ServiceManager extends Component{constructor(e){super(),this.app=e,this.services=new Map}getService(e){return this.services.get(e)}getAll(){return this.services}register(e){this.services.set(e.id,e),e.log=this.app.log,e.model=this.app.model,e.remote=this.app.remote,this.app.log.trace("Service registered: "+e.id)}}class UIManager extends Component{constructor(e){super(),this.app=e,this.events=[],this.selectors={},this.nodes={},this.queue=[],this.deferred=[],this.stateTransition=!1,this.views=[],this.app.log.trace("Layout initializing...");e=this.app.options.ui.eventGroups||"standard";switch(this.config(),e){case"extended":break;case"standard":this.events=this.standardEvents;break;default:this.app.options.ui.eventGroups.forEach(e=>this.events.concat(e))}}config(){this.standardEvents=["cached","error","abort","load","beforeunload"].concat(["online","offline"]).concat(["focus","blur"]).concat(["open","message","error","close"]).concat(["pagehide","pageshow","popstate"]).concat(["animationstart","animationend","animationiteration"]).concat(["transitionstart","transitioncancel","transitionend","transitionrun"]).concat(["reset","submit"]).concat(["beforeprint","afterprint"]).concat(["compositionstart","compositionupdate","compositionend"]).concat(["fullscreenchange","fullscreenerror","resize","scroll"]).concat(["cut","copy","paste"]).concat(["keydown","keypress","keyup"]).concat(["auxclick","click","contextmenu","dblclick","mousedown","mousenter","mouseleave","mousemove","mouseover","mouseout","mouseup","pointerlockchange","pointerlockerror","wheel"]).concat(["drag","dragend","dragstart","dragleave","dragover","drop"]).concat(["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","loadeddata","loadedmetadata","pause","play","playing","ratechange","seeked","seeking","stalled","suspend","timeupdate","columechange","waiting"]).concat(["loadend","loadstart","progress","timeout"]).concat(["change","storage"]).concat(["checking","downloading","noupdate","obsolete","updateready"]).concat(["broadcast","CheckBoxStateChange","hashchange","input","RadioStateChange","readystatechange","ValueChange"]).concat(["invalid","localized","show"])}setSelector(e,t){this.selectors[e]=t,this.nodes[e]=document.querySelector(t)}getSelector(e){return this.selectors[e]}getNode(e){return this.nodes[e]}getView(e){return this.views[e]}setStateTransition(e){this.stateTransition=e,this.app.log.trace("this.app.ui.stateTransition: "+e)}getStateTransition(){return this.stateTransition}getEvents(){return this.events}register(e){switch(this.app.options.ui.renderer){case"Handlebars":case"Mustache":case"templateLiterals":e.setLog(this.app.log),e.setModel(this.app.model),e.setUI(this.app.ui),this.views[e.props.id]=e,this.getView(e.props.parentID)&&this.getView(e.props.parentID).addChild(e),e.fireEvent("registered")}}unregister(e){delete this.views[e]}getParentViewIds(e){this.app.log.trace("Find parents of "+e);var t=[];let s=this.views[e];for(;void 0!==s.props.parentID;)t.unshift(s.props.parentID),s=this.views[s.props.parentID];return t}getChildViewIds(e){this.app.log.trace("Find children of "+e);var t,s=[],i=this.views[e];for(t in i.children){var r=i.children[t].props.id;void 0!==this.getView(r)&&(s.push(r),s.concat(this.getChildViewIds(r)))}return s}enqueueForRender(t){if(this.getStateTransition())this.deferred.push(t);else if(this.app.log.trace("enqueue: "+t),this.queue.length){var e=this.getChildViewIds(t);if(void 0===this.views[t].props.parentID)this.app.log.trace("add to front of queue: "+t),this.queue.unshift(t);else{var s=this.getParentViewIds(t);let e=void 0;void 0===(e=s.length?s.find(e=>0<=this.queue.indexOf(e)):e)&&(this.app.log.trace("add to end of queue: "+t),this.queue.push(t))}e.forEach(e=>{0<=this.queue.indexOf(e)&&(this.app.log.trace("remove child from queue: "+e),this.queue.splice(this.queue.indexOf(e),1))})}else this.app.log.trace("add first view to queue: "+t),this.queue.push(t),this.processRenderQueue()}processRenderQueue(){this.app.log.trace("processing the queue"),this.setStateTransition(!0);try{this.queue.forEach(e=>this.views[e].render())}catch(e){this.app.log.trace(e)}this.queue=[],this.setStateTransition(!1),this.deferred.forEach(e=>this.enqueueForRender(e)),this.deferred=[]}removeView(e){delete this.views[e]}}class Util{constructor(){}split(e){return e.split(/,\s*/)}extractLast(e){return this.split(e).pop()}base64={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64(e){if(!String(e).length)return!1;let t="",s,i,r,n,o,a,h,c=0;for(;s=e.charCodeAt(c++),i=e.charCodeAt(c++),r=e.charCodeAt(c++),n=s>>2,o=(3&s)<<4|i>>4,a=(15&i)<<2|r>>6,h=63&r,isNaN(i)?a=h=64:isNaN(r)&&(h=64),t=t+this.keyStr.charAt(n)+this.keyStr.charAt(o)+this.keyStr.charAt(a)+this.keyStr.charAt(h),c<e.length;);return t},decode64(e){if(!e)return!1;let t="",s,i,r,n,o,a,h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");r=this.keyStr.indexOf(e.charAt(h++)),s=(15&(n=this.keyStr.indexOf(e.charAt(h++))))<<4|(o=this.keyStr.indexOf(e.charAt(h++)))>>2,i=(3&o)<<6|(a=this.keyStr.indexOf(e.charAt(h++))),t+=String.fromCharCode(r<<2|n>>4),64!==o&&(t+=String.fromCharCode(s)),64!==a&&(t+=String.fromCharCode(i)),h<e.length;);return t}};leadingZero(e){return e<10?"0"+e:e}dynamicSort(s){let i=1;return"-"===s[0]&&(i=-1,s=s.substr(1)),function(e,t){return(e[s]<t[s]?-1:e[s]>t[s]?1:0)*i}}yesNo(e){return parseInt(e,10)<1?"No":"Yes"}isValidDate(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())}id(){return((100*Math.random()).toString()+(100*Math.random()).toString()).replace(/\./g,"")}tryCatch(e,t,s){var i={value:null};try{return e.apply(t,s)}catch(e){return i.value=e,i}}getNumberValue(e){return isNaN(Number(e))?Number(e.substring(0,e.length-2)):e}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}getOffset(e){e=e.getBoundingClientRect();return{top:e.top+document.body.scrollTop,left:e.left+document.body.scrollLeft}}debounce(i,r,n=!1){let o;return function(){let e=this,t=arguments;var s=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||i.apply(e,t)},r),s&&i.apply(e,t)}}}class Application extends Component{constructor(e){super(),this.options=this._initializeOptions(e),this.util=new Util,this.components={Component:Component,Constructor:Constructor,DataProvider:DataProvider,Entity:Entity,EventBindings:EventBindings,Model:Model,Service:Service,User:User,View:View},this.init(),this.log.info("Application initialized...")}_initializeOptions(e){return{auth:{sessionTimeout:e?.auth?.sessionTimeout??9e5},console:e?.console?{enabled:e.console.enabled??!1,wsServer:e.console.wsServer??"",container:e.console.container??("object"==typeof gadgetui?gadgetui.display.FloatingPane:""),top:e.console.top??100,left:e.console.left??500,width:e.console.width??500,height:e.console.height??300}:{},logging:{logLevel:e?.logging?.logLevel??"ERROR,FATAL,INFO",toBrowserConsole:e?.logging?.toBrowserConsole??!1},model:e?.model??"altseven",remote:e?.remote?{loginURL:e.remote.loginURL??"",logoutURL:e.remote.logoutURL??"",refreshURL:e.remote.refreshURL??"",useTokens:e?.auth?.useTokens??!0,tokenType:e.remote.tokenType??"X-Token"}:{useTokens:!0},router:e?.router?{options:{useEvents:e.router.useEvents??!0},routes:e.router.routes}:void 0,security:e?.security?{enabled:e.security.enabled??!0,options:e.security.options??{}}:{enabled:!0,options:{}},ui:{renderer:e?.ui?.renderer??("object"==typeof Mustache?"Mustache":"object"==typeof Handlebars?"Handlebars":"templateLiterals"),debounceTime:e?.ui?.debounceTime??18,timeout:e?.ui?.timeout??6e5},ready:!1}}init(){var e;return this.log=new LogManager(this),this.log.trace("application log init"),this.log.trace("application services init"),this.services=new ServiceManager(this),this.log.trace("application dataproviders init"),this.dataproviders=new DataProviderManager(this),this.log.trace("application model init"),this.model=new ModelManager(this),this.model.set(this.options?.applicationName??"a7",this.options),this.options.console.enabled&&(this.log.trace("application console init"),this.console=new Console(this)),this.options.security.enabled&&(this.log.trace("application security init"),this.security=new SecurityManager(this)),this.log.trace("application remote init"),this.remote=new RemoteManager(this),this.log.trace("application events init"),this.events=new EventManager(this),this.options.router&&(this.log.trace("application router init"),this.router=new RouterManager(this)),this.log.trace("application ui init"),this.ui=new UIManager(this),this.options.security.enabled?(this.log.trace("application security init"),this.security=new SecurityManager(this),e=this.security.isAuthenticated(),this.error=new ErrorManager,this.log.info(`Authenticated: ${e.authenticated}...`),e):{}}}export{Application};
//# sourceMappingURL=a7.min.js.map