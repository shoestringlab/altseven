function Constructor(t,e,s){var i;return!0===s&&EventBindings.getAll().forEach(function(e){void 0===t.prototype[e]&&(t.prototype[e.name]=e.func)}),i=Object.create(t.prototype),!0===s&&(i.events={},void 0!==t.prototype.events)&&t.prototype.events.forEach(function(e){i.events[e]=[]}),s=void 0===(s=t.apply(i,e))?i:s}var EventBindings={on:function(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this},off:function(e){return this.events[e]=[],this},fireEvent:function(e,t){var s=this;void 0!==this.events[e]&&this.events[e].forEach(function(e){e(s,t)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};class Component{constructor(){this.events={}}on(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this}off(e){return this.events[e]=[],this}fireEvent(e,t){void 0!==this.events[e]&&this.events[e].forEach(e=>{e(this,t)})}getAll(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}}class DataProvider extends Component{#state={};#schema;constructor(e){super(),this.binding=e?.binding,this.#state=e.state,this.#schema=e.schema,this.view=e.view,this.id=this.view.props.id+"-dataProvider",this.services=new Map,this.bindings=new Map}set schema(e){}get schema(){return this.#schema}setStateOnly(e){this.#state=Object.assign(this.#state,e)}setState(e){this.setStateOnly(e),this.fireEvent("stateChanged",e)}getState(){return Object.assign({},this.#state)}}class Entity extends Component{static schema=null;_data;constructor(e){if(super(),this._data={},this.constructor.schema){for(var[t,s]of Object.entries(this.constructor.schema))if(s.required&&!(t in e)&&void 0===e[t])throw new Error("Missing required field: "+t);for(var[i,r]of Object.entries(this.constructor.schema))this._defineProperty(i);for(var[o,n]of Object.entries(this.constructor.schema))o in e&&void 0!==e[o]&&(this[o]=e[o]);this.validate()}let a=Object.keys(this.constructor.schema).find(e=>!0===this.constructor.schema[e].id);a&&!Object.prototype.hasOwnProperty.call(this,"id")&&Object.defineProperty(this,"id",{get:function(){return this[a]}})}get schema(){return this.constructor.schema}_getData(e){return this._data["_"+e]}_setData(e,t){var s=this.constructor.schema[e],i="_"+e;let r=typeof t;if(s.required&&void 0===t)throw new Error(`Property ${e} is required.`);if("date"===s.type&&"string"==typeof t){var o=new Date(t);if(isNaN(o))throw new Error(`Invalid date string for property ${e}: `+t);t=o,r="object"}if("boolean"!==s.type||"number"!=typeof t||1!==t&&0!==t||(t=1===t,r="boolean"),"object"!==s.type||!s.entityClass||null==t||t instanceof s.entityClass||(t=new s.entityClass(t)),!this._isOfType(t,s.type,s)&&null!=t)throw new Error(`Invalid type for property ${e}. Expected ${s.type}, but got ${r}.`);this._data[i]=t}_defineProperty(s){this._data["_"+s]=void 0;var i=Object.getOwnPropertyDescriptor(this.constructor.prototype,s);if(i&&(i.get||i.set)){let e=i.get,t=i.set;Object.defineProperty(this,s,{get:e?function(){return e.call(this)}:function(){return this._getData(s)},set:t?function(e){t.call(this,e)}:function(e){this._setData(s,e)}})}else Object.prototype.hasOwnProperty.call(this,s)||Object.defineProperty(this,s,{get:function(){return this._getData(s)},set:function(e){this._setData(s,e)}})}_isOfType(e,t,s){switch(t){case"date":return e instanceof Date&&!isNaN(e);case"array":return Array.isArray(e);case"boolean":return"boolean"==typeof e;case"integer":return Number.isInteger(e);case"float":return"number"==typeof e&&!Number.isInteger(e);case"string":return"string"==typeof e;case"object":return s?.entityClass?e instanceof s.entityClass:"object"==typeof e&&null!==e;default:return!0}}validate(){for(var e in this.constructor.schema){var t="_"+e;if(this.constructor.schema[e].required&&void 0===this._data[t])throw new Error(`Field ${e} is required`);if(this.constructor.schema[e].type&&null!=this._data[t]&&!this._isOfType(this._data[t],this.constructor.schema[e].type,this.constructor.schema[e]))throw new Error(`Field ${e} must be of type `+this.constructor.schema[e].type)}return!0}toFlatObject(){var e,t,s={};for([e,t]of Object.entries(this._data))s[e.replace(/^_/,"")]=t instanceof Entity?t.toFlatObject():t;return s}fromFlatObject(e){if(!e||"object"!=typeof e)throw new Error("Invalid input: expected an object");for(var[t,s]of Object.entries(e))this.constructor.schema&&this.constructor.schema[t]&&(this[t]=s);return this}}let Model=(()=>{let n=new Map,i=new Map,s=20,a;class r{constructor(e,t){this.data=this.processValue(e),this.elements=[],this.mementos=[],this.currentMementoIndex=-1,t&&this.bind(t),this.saveMemento()}handleEvent(e){if("change"===e.type){e.originalSource??="BindableObject.handleEvent[change]";for(var{elem:t,prop:s}of this.elements){var i;e.target.name===s&&"BindableObject.updateDomElement"!==e.originalSource&&(i=e.target.type.includes("select")?{id:e.target.value,text:e.target.options[e.target.selectedIndex].textContent}:e.target.value,this.change(i,e,s))}}}change(e,s,i){s.originalSource??="BindableObject.change",a.trace("change : Source: "+s.originalSource);let t=this.processValue(e);if(i){if("object"!=typeof this.data||null===this.data)throw new Error("Attempt to treat a simple value as an object with properties.");if(!(i in this.data))throw new Error(`Property '${i}' of object is undefined.`);this.data[i]=t}else this.data=t;this.saveMemento(),this.elements.filter(({prop:e,elem:t})=>(!i||i===e)&&t!==s.target).forEach(({elem:e})=>this.updateDomElement(s,e,t))}updateDom(s,i,r){s.originalSource??="BindableObject.updateDom",this.elements.forEach(({elem:e,prop:t})=>{r?t===r&&this.updateDomElement(s,e,i):"object"==typeof i&&null!==i?t in i&&this.updateDomElement(s,e,i[t]):this.updateDomElement(s,e,i)})}updateDomElement(e,i,t){e.originalSource??="BindableObject.updateDomElement";var s=()=>{i.innerHTML="";var e=Array.isArray(t)?t:t instanceof Map?Array.from(t.entries()):[t];"SELECT"===i.tagName?e.forEach((e,t)=>{var s=document.createElement("option");s.value="object"==typeof e?e.id??e[0]:e,s.textContent="object"==typeof e?e.text??e[1]:e,i.appendChild(s)}):["UL","OL"].includes(i.tagName)&&e.forEach(e=>{var t=document.createElement("li");t.textContent="object"==typeof e?e.text??e[1]:e,i.appendChild(t)})},r=["INPUT","TEXTAREA"].includes(i.tagName),o=["OL","UL","SELECT"].includes(i.tagName),n=["DIV","SPAN","H1","H2","H3","H4","H5","H6","P","LABEL","BUTTON","A","STRONG","EM","B","I","U","SMALL","SUB","SUP","Q","BLOCKQUOTE","CITE","CODE","PRE","ABBR","DFN","SAMP","KBD","VAR","LI","DT","DD","TH","TD","CAPTION","FIGCAPTION","SUMMARY","LEGEND","TITLE"].includes(i.tagName);"object"==typeof t&&null!==t?r?i.value=t.id??(t instanceof Map?"":t[0])??"":o?s():n&&(i.textContent=t.text??(t instanceof Map?"":t[1])??""):r?i.value=t??"":o?s():n&&(i.textContent=t??""),"model.set"!==e.originalSource&&"memento.restore"!==e.originalSource&&i.dispatchEvent(new Event("change",{originalSource:"model.updateDomElement"}))}bind(e,t){var s={elem:e,prop:t||""};e.value=t?this.data[t]:this.data,e.addEventListener("change",this),this.elements.push(s)}processValue(e){switch(typeof e){case"undefined":case"number":case"boolean":case"function":case"symbol":case"string":return e;case"object":return null===e?null:e instanceof Map?new Map(e):e;default:return e}}saveMemento(){this.currentMementoIndex<this.mementos.length-1&&this.mementos.splice(this.currentMementoIndex+1);var e=this.processValue(this.data);this.mementos.push(e),this.mementos.length>s?this.mementos.shift():this.currentMementoIndex++}undo(){return 0<this.currentMementoIndex&&(this.currentMementoIndex--,this.restoreMemento(),!0)}redo(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex++,this.restoreMemento(),!0)}rewind(){return 0<this.currentMementoIndex&&(this.currentMementoIndex=0,this.restoreMemento(),!0)}fastForward(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex=this.mementos.length-1,this.restoreMemento(),!0)}restoreMemento(){this.data=this.processValue(this.mementos[this.currentMementoIndex]);let s={originalSource:"memento.restore"};this.elements.forEach(({elem:e,prop:t})=>{this.updateDomElement(s,e,t?this.data[t]:this.data)})}}return{BindableObject:r,init(e={},t){s=e.maxMementos??20,a=t},create(e,t,s){t=new r(t).processValue(t),t=new r(t,s);n.set(e,t),i.set(e,t)},destroy(e){n.delete(e),i.delete(e)},bind(e,t){var[e,s]=e.split("."),e=n.get(e);e&&e.bind(t,s)},exists(e){return n.has(e)},get(e,t){if(e){var[e,s]=e.split("."),i=n.get(e);if(i){if(!t)return(s=s?i.data[s]:i.data)instanceof Map?new Map(s):s;if(i.data instanceof Map){if(i.data.has(t))return i.data.get(t);a.trace(`Key '${t}' does not exist in the Map .`)}}else a.trace(`Key '${e}' does not exist in the model.`)}else a.error("Expected parameter [name] is not defined.")},set(e,t){if(e){var[e,s]=e.split("."),i={originalSource:"model.set"};if(n.has(e)){var r=n.get(e),o=r.processValue(t);r.change(o,i,s),r.updateDom(i,o,s)}else{if(s)throw new Error(`Object ${e} is not yet initialized.`);this.create(e,t)}}else a.error("Expected parameter [name] is not defined.")},undo(e){e=i.get(e);return!!e&&e.undo()},redo(e){e=i.get(e);return!!e&&e.redo()},rewind(e){e=i.get(e);return!!e&&e.rewind()},fastForward(e){e=i.get(e);return!!e&&e.fastForward()}}})();class Service extends Component{constructor(e){super(),this.id=e.id,this.key=e.key,this.remoteMethods=e.remoteMethods,this.entityClass=e.entityClass,this.dataProviders=new Map,this.bindings=new Map,this.log,this.model,this.remote,this.queue=new Map,this.idFields=this.getEntityIdFields(),this.fireEvent("mustRegister")}config(){this.set(new Map)}getEntityIdFields(){if(this.entityClass&&"object"==typeof this.entityClass.schema){var e,t,s=[];for([e,t]of Object.entries(this.entityClass.schema))!0===t.id&&s.push(e);return s}return[this.key]}setLog(e){this.log=e}setModel(e){this.model=e}setRemote(e){this.remote=e}registerDataProvider(e){this.dataProviders.set(e.id,e),e.log=this.log}convertArrayToMap(e){this.log.trace(this.id+": method: convertArrayToMap");let s=new Map;return e.forEach(e=>{var t=this.getCompositeKey(e);t&&s.set(t,e)}),s}convertMapToArray(e){return Array.from(e.values())}compareIDs(e){this.log.trace(this.id+": method: compareIDs"),this.log.debug(this.id+":compareIDs: "+e);let t=this.get(),s=[],i=[];return t instanceof Map?(e.forEach(e=>{(t.has(e)?s:i).push(e)}),this.log.debug(this.id+":results: "+JSON.stringify(s)+" "+JSON.stringify(i)),{present:s,missing:i}):{present:s,missing:e}}async merge(e){this.log.trace(this.id+": method: merge");let s=this.get();return s instanceof Map||(s=new Map),await Promise.all(e.map(async e=>{var t=this.getCompositeKey(e);t&&s.set(t,await this.format(e))})),this.set(s),this.fireEvent("cacheChanged",{action:"refresh"}),s}getCompositeKey(t){var e;return t&&"object"==typeof t?0===this.idFields.length?t[this.key]||null:1===this.idFields.length?t[this.idFields[0]]||null:0<(e=this.idFields.map(e=>t[e]).filter(e=>null!=e)).length?e.join("|"):null:null}bind(e,t){this.bindings.set(e,{filter:t})}async create(e){this.log.trace(this.id+": method: create");var e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.create,e)).json();return e.fromFlatObject(t),this.cacheSet(e),e}async read(r){this.log.trace(this.id+": method: read");let o=this.get(),n,a=this.remoteMethods.read+"-"+JSON.stringify(r);var e;return this.queue.has(a)?(this.log.debug(this.id+":Duplicate read request detected, waiting for existing request. "+JSON.stringify(r)),this.queue.get(a)):(this.log.debug(this.id+": New read request. "+JSON.stringify(r)),e=new Promise(async(e,t)=>{try{var s,i;n=this.getCompositeKey(r),o.has(n)||(s=r instanceof this.entityClass?r:await this.format(r),i=await(await this.remote.invoke(this.remoteMethods.read,s)).json(),s.fromFlatObject(i),this.cacheSet(await this.format(s))),e(o.get(n))}catch(e){this.log.debug(this.id+": Error reading object. "+e),t(e)}finally{this.queue.delete(a)}}),this.queue.set(a,e),this.log.debug(this.id+": read request added to the queue."),e)}async update(e){this.log.trace(this.id+": method: update");var e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.update,e)).json();return e.fromFlatObject(t),this.cacheSet(e),e}async delete(e){this.log.trace(this.id+": method: delete");var t={},e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.delete,e)).json(),e=this.getCompositeKey(e);return this.cacheDelete(e),t}async readAll(i={}){this.log.trace(this.id+": method: readAll");let r=this.remoteMethods.readAll+"-"+JSON.stringify(i);var e;return this.queue.has(r)?(this.log.debug(this.id+":Duplicate readAll request detected, waiting for existing request."),this.queue.get(r)):(this.log.debug(this.id+":Creating new readAll request."),e=new Promise(async(e,t)=>{try{var s;this.get().size||(s=await(await this.remote.invoke(this.remoteMethods.readAll,i)).json(),await this.merge(s)),e(this.get())}catch(e){t(e)}finally{this.queue.delete(r)}}),this.queue.set(r,e),this.log.debug(this.id+":readAll completed for "+i.id),e)}async invoke(e,t,s={merge:!0,checkCache:!0,filter:{},returnType:"Map"}){this.log.trace(this.id+": method: invoke");var i=this.remoteMethods[e];if(!i)throw new Error(`Method ${e} not found in remoteMethods`);if(s?.checkCache){var r=this.get(),r=void 0===s.filter||void 0!==s.filter&&0===Object.keys(s.filter).length?r:this.filter(r,s.filter);if(0<r.length)return this.log.debug(this.id+": Cache hit for method",e),this.formatData(r,s.returnType)}e=await(await this.remote.invoke(i,t)).json();return s.merge?(Array.isArray(e)&&0<e.length?await this.merge(e):"object"==typeof e&&null!==e&&await this.merge([e]),this.formatData(e,s.returnType)):e}async format(e){return this.log.trace(this.id+": method: format"),new this.entityClass(e)}async formatData(s,i){this.log.trace(this.id+": method: formatData");let r=new Map,o=[];var e;return"object"!=typeof s||Array.isArray(s)||null===s?"object"===i&&1===s.length?(e=s[0])instanceof this.entityClass?e:await this.format(e):(await Promise.all(s.map(async(e,t)=>{s[t]=e instanceof this.entityClass?e:await this.format(e),"Map"===i&&r.set(s[t].id,s[t]),"Array"===i&&o.push(s[t])})),"Map"===i?r:"Array"===i?o:void 0):this.format(s)}cacheDelete(e){this.log.trace(this.id+": method: cacheDelete");var t=this.get();t.delete(e),this.set(t),this.fireEvent("cacheChanged",{action:"delete"})}cacheSet(e){if(this.log.trace(this.id+": method: cacheSet"),!(e instanceof this.entityClass))throw"Item must be of proper entity type.";var t=this.getCompositeKey(e);if(!t)throw new Error("Cannot cache item: no valid ID fields found");var s=this.get();s.set(t,e),this.set(s),this.fireEvent("cacheChanged",{action:"refresh"})}set(e){this.log.trace(this.id+": method: set"),this.model.set(this.id,e)}get(e){return this.log.trace(this.id+": method: get"),void 0===e?this.model.get(this.id):this.model.get(this.id,e)}async readMany(n){if(this.log.trace(this.id+": method: readMany"),void 0===n)return new Map;let a=this.remoteMethods.readMany+"-"+JSON.stringify(n);var e;return this.queue.has(a)?(this.log.debug(this.id+":Duplicate readMany request detected, waiting for existing request."+n),this.queue.get(a)):(this.log.debug(this.id+": New readMany: "+n),e=new Promise(async(e,t)=>{try{var s,i,{present:r,missing:o}=this.compareIDs(n);this.log.debug(this.id+": Present? "+r.length),this.log.debug(this.id+": Missing? "+o.length),0<o.length&&(s={id:o},i=await(await this.remote.invoke(this.remoteMethods.readMany,s)).json(),Array.isArray(i))&&await this.merge(i),e(this.getMappedItems(n))}catch(e){t(e)}finally{this.queue.delete(a)}}),this.queue.set(a,e),this.log.debug(this.id+": Completed readMany: "+n),e)}getMappedItems(e){return this.log.trace(this.id+": method: getMappedItems"),e.map(e=>this.get(e)||null).filter(e=>null!==e)}sort(e,n){this.log.trace(this.id+": method: sort");e=e instanceof Map?Array.from(e.values()):e;if(n&&"object"==typeof n&&0!==Object.keys(n).length)return e.sort((e,t)=>{for(var s of Object.keys(n)){var i=n[s]||"asc",r=e[s],o=t[s];if(void 0!==r&&void 0!==o){if(typeof r!=typeof o)throw new Error(`Inconsistent types for sorting field '${s}'`);if("string"==typeof r)return s=r.localeCompare(o),"asc"===i?s:-s;if(r<o)return"asc"===i?-1:1;if(o<r)return"asc"===i?1:-1}}return 0}),e;throw new Error("Invalid sort fields provided")}filter(e,n){this.log.trace(this.id+": method: filter");e=Array.isArray(e)?e:Array.from(e.values());if(!n||"object"!=typeof n||0===Object.keys(n).length)throw new Error("Invalid filter criteria provided");let a=(e,t,s)=>{switch(s){case"=":return e===t;case"!=":return e!==t;case">":return t<e;case"<":return e<t;case">=":return t<=e;case"<=":return e<=t;case"∈":case"in":return Array.isArray(t)&&t.includes(e);case"∉":case"not in":return Array.isArray(t)&&!t.includes(e);default:throw new Error("Invalid operator: "+s)}};return e.filter(e=>{for(var t of Object.keys(n)){var s=n[t],t=e[t];if(Array.isArray(s)&&3===s.length){var[i,r,o]=s,r="function"==typeof r?r():r;if(o&&"string"==typeof r){o=new RegExp(r);if(!a(t.toString(),o.test(t),i))return!1}else if(!a(t,r,i))return!1}else if(Array.isArray(s)&&2===s.length){o=s[0],r="function"==typeof s[1]?s[1]():s[1];if("object"==typeof r&&Array.isArray(r)){if(!((e,t)=>{if(Array.isArray(t)&&2===t.length)return e>=t[0]&&e<=t[1];throw new Error("Range must be an array with two elements")})(t,r))return!1}else if(!a(t,r,o))return!1}else if(!a(t,s,"="))return!1}return!0})}}class User extends Component{constructor(e){super(),Object.assign(this,e)}getMemento(){let t={},s=this;return Object.keys(this).forEach(e=>{t[e]=s[e]}),t}}class View extends Component{constructor(e){super(),this.type="View",this.timeout=6e5,this.renderer="templateLiterals",this.debounceTime=18,this.timer,this.element,this.props=e,this.log,this.model,this.ui,this.isTransient=e.isTransient||!1,this.state={},this.skipRender=!1,this.children={},this.components={},this.fireEvent("mustRegister")}setLog(e){this.log=e}setModel(e){this.model=e}setUI(e){this.ui=e}setRenderer(e){this.renderer=e}setTimeout(e){this.timeout=e}setDebounce(e){this.debounce=e}setDebounceTime(e){this.debounceTime=e}config(){this.on("mustRender",this.debounce(function(){this.log.trace("mustRender: "+this.props.id),this.shouldRender()?this.ui.enqueueForRender(this.props.id):(this.log.trace("Render cancelled: "+this.props.id),this.skipRender=!1)}.bind(this),this.debounceTime)),this.on("rendered",function(){this.isTransient&&(void 0!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.checkRenderStatus.bind(this),this.timeout)),this.onRendered()}.bind(this)),this.on("registered",function(){void 0!==this.props.parentID&&!this.mustRender||this.fireEvent("mustRender")}.bind(this)),this.on("mustUnregister",function(){this.ui.unregister(this.props.id)}.bind(this))}setState(e){this.dataProvider?this.dataProvider.setState(e):(this.state=Object.assign(this.state,e),this.fireEvent("stateChanged",e)),this.fireEvent("mustRender")}getState(){return this.dataProvider?this.dataProvider.getState():Object.assign(this.state)}registerDataProvider(e){this.dataProvider=e,this.dataProvider.on("stateChanged",(e,t)=>{this.fireEvent("stateChanged",t)})}unregisterDataProvider(){this.dataProvider=null}addChild(e){this.children[e.props.id]=e}removeChild(e){delete this.children[e.props.id]}clearChildren(){this.children={}}getParent(){return this.props.parentID?this.ui.getView(this.props.parentID):void 0}render(){var t;this.log.trace("render: "+this.props.id),null==this.element&&(this.element=document.querySelector(this.props.selector)),this.element?(this.element.innerHTML="function"==typeof this.template?this.template():this.template,t=[],this.ui.getEvents().forEach(function(e){t.push("[data-on"+e+"]")}),this.element.querySelectorAll(t.toString()).forEach(function(e){for(var t=0;t<e.attributes.length;t++){var s=e.attributes[t];s.name.startsWith("data-on")&&(s=s.name.substring(7,s.name.length),e.addEventListener(s,this.eventHandlers[e.attributes["data-on"+s].value]))}}.bind(this)),this.element.querySelectorAll("[data-bind]").forEach(function(e){this.model.bind(e.attributes["data-bind"].value,e)}),this.log.trace("Rendered: "+this.props.id),this.fireEvent("rendered")):(this.log.trace("The DOM element for view "+this.props.id+" was not found. The view will be removed and unregistered."),void 0!==this.props.parentID&&this.ui.getView(this.props.parentID).removeChild(this),this.fireEvent("mustUnregister"))}shouldRender(){return!this.skipRender}onRendered(){for(var e in this.children)this.children[e].element=document.querySelector(this.children[e].props.selector),this.children[e].render()}checkRenderStatus(){null===document.querySelector(this.props.selector)?this.ui.unregister(this.id):this.isTransient&&(this.timer=setTimeout(this.checkRenderStatus.bind(this),this.timeout))}}class Console extends Component{constructor(e){super(),this.title="Console Window",this.consoleDiv=null,this.active=!1,this.app=e,this.resolve=resolve,this.reject=reject,this.options=this.app.options.console,this.options.enabled?(this.active=!0,this.consoleDiv=document.createElement("div"),this.consoleDiv.setAttribute("id","a7consoleDiv"),this.consoleDiv.setAttribute("class","a7-console"),document.body.appendChild(this.consoleDiv),(e=new this.options.container(this.consoleDiv,{width:this.options.width,left:this.options.left,height:this.options.height,title:this.title,top:this.options.top,enableShrink:!0,enableClose:!0})).element&&e.element.setAttribute("right",0),this.options.wsServer&&a7.remote.webSocket(this.options.wsServer,this.handleMessage.bind(this)),a7.console.addMessage=this.addMessage.bind(this),a7.log.info("Console initializing..."),this.resolve()):this.reject("Console init should not be called when console option is set to false.")}addMessage(e,t,s,i){var r=document.createElement("div");r.setAttribute("class","a7-console-row-"+s),void 0!==i&&(r.innerHTML=i+": ",r.setAttribute("class",r.getAttribute("class")+" a7-console-row-"+i)),r.innerHTML+=+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+": "+e,this.consoleDiv.appendChild(r)}handleMessage(e,t){var s=0;if("history"===t.type)for(s=0;s<t.data.length;s++)this.addMessage(t.data[s].text,new Date(t.data[s].time),"websocket");else"message"===t.type?this.addMessage(t.data.text,new Date(t.data.time),"websocket"):a7.log.error("This doesn't look like valid JSON: ",t)}}class DataProviderManager extends Component{constructor(e){super(),this.app=e,this.services=this.app.services.getAll(),this._dataproviders=new Map,e.log.info("DataProviderManager initialized...")}getDataProvider(e){return this._dataproviders.get(e)}getAll(){return this._dataproviders}register(t){this._dataproviders.set(t.id,t),this.bind(t),this.services.forEach(e=>{e.registerDataProvider(t)}),this.app.log.trace(`DataProvider "${t.id}" registered.`)}bind(r){if(r.binding)for(let i in r.binding){var e,t,s,o,n=r.binding[i].dependencies||null,a=[...this.services.values()].find(e=>e.entityClass===r.binding[i].entityClass);a&&(this.app.log.trace("Binding: ",i),e=r.binding[i].filter||null,t=r.binding[i].func||null,o=r.binding[i].sort||null,s=r.binding[i].id||null,r.bindings.set(i,{key:i,service:a,filter:e,sort:o,func:t,dependencies:n,id:s}),a.bind(i,e),o=this.getBoundData(r,r.bindings.get(i)),r.setStateOnly({[i]:o}),a.on("cacheChanged",(e,t)=>{t.state=r.getState(),this.updateBoundState(r,r.bindings.get(i),t)})),(n=r.binding[i].dependencies||[]).forEach(e=>{let s=e.split(".");1===s.length?r.on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[s]in t&&(this.app.log.trace("updated "+s),this.updateBoundState(r,r.bindings.get(i),{action:"refresh",state:r.getState()}))}):2===s.length&&this.app.ui.getView(s[0]).on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[s[1]]in t&&(this.app.log.trace("updated "+s[1]),this.updateBoundState(r,r.bindings.get(i),{action:"refresh",state:r.getState(),dependentState:e.getState()}))})})}}getBoundData(e,t){let s;e=e.schema[t.key].type;return"object"===e?s=t.service.get(t.id):"map"===e&&(s=t.service.get(),null!==t.filter&&(s=t.service.filter(s,t.filter)),null!==t.sort)&&(s=t.service.sort(s,t.sort)),s}async updateBoundState(e,t,s){let i;null!==t.func?(s=Object.assign(s,{filter:t.filter,sort:t.sort}),i="AsyncFunction"===t.func.constructor.name?await t.func(s,e):t.func(s,e),"map"===e.schema[t.key].type&&Array.isArray(i)&&(i=t.service.convertArrayToMap(i)),e.view.setState({[t.key]:i})):(s=this.getBoundData(e,t),e.view.setState({[t.key]:s}))}}class ErrorManager extends Component{constructor(e){super(),this.app=e,window.onerror=(e,t,s,i,r)=>(this.captureError(e,t,s,i,r),!1),e.log.info("ErrorManager initialized...")}captureError(e,t,s,i,r){var o;-1<e.toLowerCase().indexOf("script error")?this.app.log.error("Script Error: See Browser Console for Detail"):(o=["Message: "+e,"URL: "+t,"Line: "+s,"Column: "+i,"Error object: "+JSON.stringify(r)].join(" - "),this.fireEvent("scriptError",[e,t,s,i,r]),this.app.log.error(o))}}class EventManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,this.topics={},this.hasProp=this.topics.hasOwnProperty,this.subscribe("auth.login",e=>{this.app.remote.invoke("auth.login",e)}),this.subscribe("auth.logout",e=>{this.app.remote.invoke("auth.logout",e)}),this.subscribe("auth.refresh",e=>{this.app.remote.invoke("auth.refresh",e)}),this.subscribe("auth.sessionTimeout",()=>{this.app.security.invalidateSession()}),this.subscribe("auth.invalidateSession",()=>{this.app.security.invalidateSession()});for(var[t,s]of Object.entries(this.options.events))this.subscribe(t,s)}subscribe(e,t){this.hasProp.call(this.topics,e)||(this.topics[e]=[]);var s=this.topics[e].push(t)-1;return{remove:()=>{delete this.topics[e][s]}}}publish(e,t){this.app.log.trace("event: "+e),this.hasProp.call(this.topics,e)&&this.topics[e].forEach(function(e){e(t||{})})}}class LogManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,this._ready=!1,this._deferred=[],this.logLevel=this.options.logging.logLevel,this._toBrowserConsole=this.options.logging.toBrowserConsole,this._consoleEnabled=this.options.console.enabled,this._ready=!0,this._deferred.forEach(e=>{this.log(e.message,e.level)}),this._deferred=[],this.info("Log initializing..."),this.fireEvent("initialized")}error(e){this.log(e,"ERROR")}fatal(e){this.log(e,"FATAL")}info(e){this.log(e,"INFO")}trace(e){this.log(e,"TRACE")}debug(e){this.log(e,"DEBUG")}warn(e){this.log(e,"WARN")}log(e,t){this._ready&&0<=this.logLevel.indexOf(t)||0<=this.logLevel.indexOf("ALL")?(this._consoleEnabled&&a7.console.addMessage(e,new Date,"local",t),this._toBrowserConsole&&console.log(e)):this._ready||this._deferred.push({message:e,level:t})}}class ModelManager extends Component{constructor(e){if(super(),this.app=e,this.options=this.app.options,this._model=null,this._methods={},e.log.info("Model initializing... "),"string"==typeof this.options.model)switch(this.options.model){case"altseven":this._model=Model,this._model.init(this.options,this.app.log);break;case"gadgetui":this._model=gadgetui.model}else"object"==typeof this.options.model&&(this._model=this.options.model);e.log.trace("Model set: "+this._model),Object.keys(this._model).forEach(e=>{this._methods[e]=this._model[e]})}destroy(...e){return this._methods.destroy.apply(this._model,e)}get(...e){return this._methods.get.apply(this._model,e)}set(...e){return this._methods.set.apply(this._model,e)}exists(...e){return this._methods.exists.apply(this._model,e)}bind(...e){return this._methods.bind.apply(this._model,e)}undo(...e){return this._methods.undo.apply(this._model,e)}redo(...e){return this._methods.redo.apply(this._model,e)}rewind(...e){return this._methods.rewind.apply(this._model,e)}fastForward(...e){return this._methods.fastForward.apply(this._model,e)}}class RemoteManager extends Component{constructor(e){super(),this.connections={},this.app=e,this.options=e.options.remote||{},this.time=new Date,this.sessionTimer,this.modules={},this.init(this.options.modules),this.token,e.log.trace("RemoteManager initializing... ")}setModule(e,t){this.modules[e]=t}webSocket(e,t,s=!1){let i;var r;i=e.startsWith("ws://")||e.startsWith("wss://")?(r=new URL(e),this.options.useTokens&&r.searchParams.set("token",this.token),r.toString()):(s?"wss://":"ws://")+e.replace(/\/+$/,""),this.app.log.trace("WebSocket connecting to:",i);let o=new WebSocket(i);return o.onopen=()=>{this.app.log.trace(`WebSocket connection to ${i} established...`),this.fireEvent("webSocketOpen",[o])},o.onerror=e=>{var t;console.error("WebSocket connection failed:",e),i.endsWith("/")&&(t=i.slice(0,-1),this.app.log.trace("Trying alternative URL:",t)),this.app.log.error("WebSocket error:",e),this.fireEvent("webSocketError",[e])},o.onclose=()=>{this.app.log.trace(`WebSocket connection to ${i} closed.`),this.fireEvent("webSocketClose",[])},o.onmessage=async e=>{e=JSON.parse(e.data);this.app.log.trace("Received message:",e),"AsyncFunction"===t.constructor.name?await t(e):t(e),this.fireEvent("webSocketMessage",[e])},this.connections[i]=o}getConnection(e){return this.connections[e]}closeConnection(e){this.connections[e]&&(this.connections[e].close(),delete this.connections[e],this.app.log.trace(`WebSocket connection to ${e} closed.`))}closeAllConnections(){for(var e in this.connections)this.closeConnection(e)}async refreshClientSession(){try{await this.invoke("auth.refresh",{resolve:e=>{e.authenticated?this.app.log.trace("Still logged in."):(this.app.log.trace("Session expired."),this.app.events.publish("auth.logout"))},reject:e=>{this.app.log.error("Error in refreshClientSession:",e),this.app.events.publish("auth.logout")}})}catch(e){this.app.log.error("Error in refreshClientSession:",e),this.app.events.publish("auth.logout")}}setToken(e){sessionStorage.token=e,this.token=e}getToken(){return this.token}invalidateToken(){this.setToken("")}getSessionTimer(){return this.sessionTimer}init(t){var e=this.app.options.auth,e=(this.options.sessionTimeout=e.sessionTimeout,this.options.useTokens&&sessionStorage.token&&""!==sessionStorage.token&&(this.token=sessionStorage.token),{login:async e=>{this.app.log.trace("remote call: auth.login");var s={method:"POST",headers:{Authorization:"Basic "+this.app.util.base64.encode64(e.username+":"+e.password),Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({rememberMe:e.rememberMe||!1})};try{var i,r,o=await fetch(this.options.loginURL,s);this.options.useTokens&&null!=(i="X-Token"===this.options.tokenType?o.headers.get("X-Token"):o.headers.get("Access_token"))&&this.setToken(i);let t=await o.json();t.success?(r=this.app.model.get("user"),Object.keys(t.user).map(e=>{r[e]=t.user[e]}),sessionStorage.user=JSON.stringify(r),this.app.model.set("user",r),this.app.log.trace("User set into model:",r),void 0!==e.success&&("function"==typeof e.success?e.success(t):this.app.options.router?this.app.router.open(e.success,t):this.app.events.publish(e.success,t))):void 0!==e.failure&&("function"==typeof e.failure?e.failure(t):this.app.options.router?this.app.router.open(e.failure,t):this.app.events.publish(e.failure,t)),void 0!==e.callback&&e.callback(t)}catch(e){this.app.log.error("Login error:",e)}},logout:async e=>{this.app.log.trace("remote call: auth.logout");try{var t=await(await fetch(this.options.logoutURL,{method:"POST",headers:{}})).json();t.success?(this.app.security.invalidateSession(),void 0!==e.success&&("function"==typeof e.success?e.success(t):this.app.options.router?this.app.router.open(e.success,t):this.app.events.publish(e.success,t))):void 0!==e.failure&&("function"==typeof e.failure?e.failure(t):this.app.options.router?this.app.router.open(e.failure,t):this.app.events.publish(e.failure,t)),void 0!==e.callback&&e.callback()}catch(e){this.app.log.error("Logout error:",e)}},refresh:async t=>{try{var s=await this.fetch(this.options.refreshURL,{},!0);let e;e=401===s.status?{isauthenticated:!1}:await s.json(),void 0!==t.resolve&&t.resolve(e)}catch(e){t.reject&&t.reject(e)}}});this.setModule("auth",e),Object.keys(t).forEach(e=>{this.setModule(e,t[e])})}async fetch(e,t,s){if(this.app.log.trace("fetch: "+e),s&&this.options.useTokens){var i=new Date,r=Math.abs(i-this.time);if(Math.floor(r/1e3/60)>this.options.sessionTimeout)return void this.app.events.publish("auth.sessionTimeout");null!=this.token&&(void 0===t.headers?"X-Token"===this.options.tokenType?t.headers={"X-Token":this.token}:t.headers={Authorization:"Bearer "+this.getToken()}:"X-Token"===this.options.tokenType?t.headers["X-Token"]=this.token:t.headers.Authorization="Bearer "+this.getToken()),this.time=i}r=new Request(e,t);try{var o,n=await fetch(r);return s&&this.options.useTokens&&(null!=(o="X-Token"===this.options.tokenType?n.headers.get("X-Token"):n.headers.get("Access_token"))?(this.setToken(o),void 0!==this.sessionTimer&&clearTimeout(this.sessionTimer),this.sessionTimer=setTimeout(()=>{this.refreshClientSession()},this.options.sessionTimeout)):this.app.events.publish("auth.sessionTimeout")),n}catch(e){throw this.app.log.error(e),e}}async genericFetch(e,t,s=null,i={}){e={method:e,headers:i};return s&&(e.body=JSON.stringify(s)),this.fetch(t,e,!0)}async readAll(e){return this.genericFetch("GET",e.url)}async create(e,t){return this.genericFetch("POST",e.url,t,{Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"})}async read(e,t){let s=e.url;return Object.keys(t).forEach(e=>{s=s.replace(new RegExp(":"+e,"g"),t[e])}),this.genericFetch("GET",s)}async update(e,t){let s=e.url;Object.keys(t).forEach(e=>{s=s.replace(new RegExp(":"+e,"g"),t[e])});return this.genericFetch("PUT",s,t,{Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"})}async destroy(e,t){let s=e.url;return Object.keys(t).forEach(e=>{s=s.replace(new RegExp(":"+e,"g"),t[e])}),this.genericFetch("DELETE",s)}async invoke(e,t){e=e.split(".");if(e.length<2)this.app.log.error("No action specified. Valid actions are: "+Object.keys(this.modules[e[0]]).toString());else{var s=e[0],e=e[1];if("function"==typeof this.modules[s][e])return this.modules[s][e](t);if("object"==typeof this.modules[s][e]){var i=this.modules[s][e];switch(e){case"read":return this.read(i,t.toFlatObject());case"readAll":return this.readAll(i);case"create":return this.create(i,t.toFlatObject());case"update":return this.update(i,t.toFlatObject());case"destroy":return this.destroy(i,t.toFlatObject());default:return this.invokeCustomMethod(i,t)}}else this.app.log.error("Invalid action: "+e)}}async invokeCustomMethod(e,t){var s=e.params&&e.params.method||"GET";let i=e.url;"object"==typeof t&&null!==t&&Object.keys(t).forEach(e=>{i=i.replace(new RegExp(":"+e,"g"),t[e])});var r={};let o=null;t.body&&(o=JSON.stringify(t.body),r["Content-Type"]="application/json; charset=utf-8"),e.params&&e.params.headers&&Object.assign(r,e.params.headers);e={method:s.toUpperCase(),headers:r};return o&&(e.body=o),this.fetch(i,e,!0)}}class RouterManager extends Component{constructor(e,t){super(),this.app=e,this.router=new Router(e.options.router.routes),this.useEvents=this.app.options.router.options.useEvents??!1,window.onpopstate=e=>{this.match(document.location.pathname+document.location.search)},e.log.info("RouterManager initialized...")}add(e,t){return this.router.add(e,t),this}find(e){return this.router.find(e)}open(e,t={}){var s=this.find(e);s&&s.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},s.params||{}),this.useEvents&&"string"==typeof s.handler?this.app.events.publish(s.handler,t):s.handler(t)):this.app.log.error("No route found for path: "+e)}match(e,t={}){var s=this.find(e);s&&s.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},s.params||{}),this.useEvents?this.app.events.publish(s.handler,t):s.handler(t)):this.app.log.error("No route found for path: "+e)}}class Router{constructor(e){this.REGEX_PARAM_DEFAULT=/^[^/]+/,this.REGEX_START_WITH_PARAM=/^(:\w|\()/,this.REGEX_INCLUDE_PARAM=/:\w|\(/,this.REGEX_MATCH_PARAM=/^(?::(\w+))?(?:\(([^)]+)\))?/,this.root=this.createNode(),e&&e.forEach(e=>this.add.apply(this,e))}createNode(e={}){var{regex:e=null,param:t=null,handler:s=null}=e;return{regex:e,param:t,handler:s,children:{string:{},regex:{}}}}add(e,t){return this.parseOptim(e,t,this.root),this}parse(t,s,i){if(this.REGEX_START_WITH_PARAM.test(t)){var r=t.match(this.REGEX_MATCH_PARAM);let e=i.children.regex[r[0]];e=e||(i.children.regex[r[0]]=this.createNode({regex:r[2]?new RegExp("^"+r[2]):this.REGEX_PARAM_DEFAULT,param:r[1]})),r[0].length===t.length?e.handler=s:this.parse(t.slice(r[0].length),s,e)}else{r=t[0];let e=i.children.string[r];e=e||(i.children.string[r]=this.createNode()),this.parse(t.slice(1),s,e)}}parseOptim(e,t,s){var i;this.REGEX_INCLUDE_PARAM.test(e)?this.parse(e,t,s):(i=s.children.string[e])?i.handler=t:s.children.string[e]=this.createNode({handler:t})}find(e){return this.findOptim(e,this.root,{})}findOptim(e,t,s){var i=t.children.string[e];return i&&void 0!==i.handler?{handler:i.handler,params:s}:this._find(e,t,s)}_find(e,t,s){var i,r=t.children.string[e[0]];if(r){r=this._find(e.slice(1),r,s);if(r)return r}for(i in t.children.regex){var o=t.children.regex[i],n=e.match(o.regex);if(n){if(n[0].length===e.length&&void 0!==o.handler)return o.param&&(s[o.param]=decodeURIComponent(n[0])),{handler:o.handler,params:s};var a=this.findOptim(e.slice(n[0].length),o,s);if(a)return o.param&&(s[o.param]=decodeURIComponent(n[0])),a}}return null}}class SecurityManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,e.log.info("Security initializing..."),this.useModel=0<this.options.model.length,this.userArgs=this.options.security.userArgs||[];e=this.getUser();this.setUser(e)}async isAuthenticated(){return this.app.log.trace("Checking authenticated state.. "),this.authRefreshPromise?this.app.log.trace("Waiting for existing auth.refresh call to complete"):this.authRefreshPromise=new Promise(async(e,t)=>{try{var s=await this.app.remote.invoke("auth.refresh",{resolve:e,reject:t});s.authenticated&&this.setUser(s.user),this.app.log.trace("Resolving the response... "),e(s)}catch(e){t(e)}finally{this.authRefreshPromise=null}}),this.authRefreshPromise}invalidateSession(){clearTimeout(this.app.remote.getSessionTimer()),this.app.remote.invalidateToken();var e=new User(this.userArgs);this.setUser(e)}setUser(e){this.useModel&&this.app.model.set("user",e),sessionStorage.user=JSON.stringify(e)}getUser(){let t,s;var e=this.useModel?this.app.model.get("user"):null;if(void 0!==e&&""!==e&&null!==e)s=e;else if(void 0!==sessionStorage.user&&""!==sessionStorage.user)try{t=JSON.parse(sessionStorage.user),s=new User(this.userArgs),Object.keys(t).map(e=>s[e]=t[e])}catch(e){console.error("Error parsing user data:",e),s=new User(this.userArgs)}else s=new User(this.userArgs);return s}}class ServiceManager extends Component{constructor(e){super(),this.app=e,this.services=new Map}getService(e){return this.services.get(e)}getAll(){return this.services}register(e){this.services.set(e.id,e),e.setLog(this.app.log),e.setModel(this.app.model),e.setRemote(this.app.remote),e.config(),this.app.log.trace("Service registered: "+e.id)}}class UIManager extends Component{#handleMouseMove(e){this.mousePosition={x:e.clientX,y:e.clientY}}#debouncedMouseMove;constructor(e){super(),this.app=e,this.options=e.options,this.events=[],this.selectors={},this.nodes={},this.queue=[],this.deferred=[],this.stateTransition=!1,this.mousePosition={x:0,y:0},this.views=[],e.log.trace("Layout initializing...");e=this.options.ui.eventGroups||"standard";switch(this.config(),e){case"extended":break;case"standard":this.events=this.standardEvents;break;default:this.options.ui.eventGroups.forEach(e=>this.events.concat(e))}this.options.ui.enableMouseTracking&&this.enableMouseTracking(!0)}config(){this.standardEvents=["cached","error","abort","load","beforeunload"].concat(["online","offline"]).concat(["focus","blur"]).concat(["open","message","error","close"]).concat(["pagehide","pageshow","popstate"]).concat(["animationstart","animationend","animationiteration"]).concat(["transitionstart","transitioncancel","transitionend","transitionrun"]).concat(["reset","submit"]).concat(["beforeprint","afterprint"]).concat(["compositionstart","compositionupdate","compositionend"]).concat(["fullscreenchange","fullscreenerror","resize","scroll"]).concat(["cut","copy","paste"]).concat(["keydown","keypress","keyup"]).concat(["auxclick","click","contextmenu","dblclick","mousedown","mousenter","mouseleave","mousemove","mouseover","mouseout","mouseup","pointerlockchange","pointerlockerror","wheel"]).concat(["drag","dragend","dragstart","dragleave","dragover","drop"]).concat(["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","loadeddata","loadedmetadata","pause","play","playing","ratechange","seeked","seeking","stalled","suspend","timeupdate","columechange","waiting"]).concat(["loadend","loadstart","progress","timeout"]).concat(["change","storage"]).concat(["checking","downloading","noupdate","obsolete","updateready"]).concat(["broadcast","CheckBoxStateChange","hashchange","input","RadioStateChange","readystatechange","ValueChange"]).concat(["invalid","localized","show"])}enableMouseTracking(e){e?(this.#debouncedMouseMove=this.app.util.debounce(this.#handleMouseMove.bind(this),this.options.ui.mouseTrackingDeBounceTime),document.addEventListener("mousemove",this.#debouncedMouseMove)):document.removeEventListener("mousemove",this.#debouncedMouseMove)}setSelector(e,t){this.selectors[e]=t,this.nodes[e]=document.querySelector(t)}getSelector(e){return this.selectors[e]}getNode(e){return this.nodes[e]}getView(e){return this.views[e]}setStateTransition(e){this.stateTransition=e,this.app.log.trace("this.app.ui.stateTransition: "+e)}getStateTransition(){return this.stateTransition}getEvents(){return this.events}register(e){switch(this.options.ui.renderer){case"Handlebars":case"Mustache":case"templateLiterals":e.setLog(this.app.log),e.setModel(this.app.model),e.setUI(this.app.ui),e.setTimeout(this.app.options.ui.timeout),e.setDebounceTime(this.app.options.ui.debounceTime),e.setRenderer(this.app.options.ui.renderer),e.setDebounce(this.app.util.debounce),e.config(),this.views[e.props.id]=e,this.getView(e.props.parentID)&&this.getView(e.props.parentID).addChild(e),e.fireEvent("registered")}}unregister(e){delete this.views[e]}getParentViewIds(e){this.app.log.trace("Find parents of "+e);var t=[];let s=this.views[e];for(;void 0!==s.props.parentID;)t.unshift(s.props.parentID),s=this.views[s.props.parentID];return t}getChildViewIds(e){this.app.log.trace("Find children of "+e);var t,s=[],i=this.views[e];for(t in i.children){var r=i.children[t].props.id;void 0!==this.getView(r)&&(s.push(r),s.concat(this.getChildViewIds(r)))}return s}enqueueForRender(t){if(this.getStateTransition())this.deferred.push(t);else if(this.app.log.trace("enqueue: "+t),this.queue.length){var e=this.getChildViewIds(t);if(void 0===this.views[t].props.parentID)this.app.log.trace("add to front of queue: "+t),this.queue.unshift(t);else{var s=this.getParentViewIds(t);let e=void 0;void 0===(e=s.length?s.find(e=>0<=this.queue.indexOf(e)):e)&&(this.app.log.trace("add to end of queue: "+t),this.queue.push(t))}e.forEach(e=>{0<=this.queue.indexOf(e)&&(this.app.log.trace("remove child from queue: "+e),this.queue.splice(this.queue.indexOf(e),1))})}else this.app.log.trace("add first view to queue: "+t),this.queue.push(t),this.processRenderQueue()}processRenderQueue(){this.app.log.trace("processing the queue"),this.setStateTransition(!0);try{this.queue.forEach(e=>this.views[e].render())}catch(e){this.app.log.error(e)}this.queue=[],this.setStateTransition(!1),this.deferred.forEach(e=>this.enqueueForRender(e)),this.deferred=[]}removeView(e){delete this.views[e]}}class Util{constructor(){}split(e){return e.split(/,\s*/)}extractLast(e){return this.split(e).pop()}base64={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64(e){if(!String(e).length)return!1;let t="",s,i,r,o,n,a,h,c=0;for(;s=e.charCodeAt(c++),i=e.charCodeAt(c++),r=e.charCodeAt(c++),o=s>>2,n=(3&s)<<4|i>>4,a=(15&i)<<2|r>>6,h=63&r,isNaN(i)?a=h=64:isNaN(r)&&(h=64),t=t+this.keyStr.charAt(o)+this.keyStr.charAt(n)+this.keyStr.charAt(a)+this.keyStr.charAt(h),c<e.length;);return t},decode64(e){if(!e)return!1;let t="",s,i,r,o,n,a,h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");r=this.keyStr.indexOf(e.charAt(h++)),s=(15&(o=this.keyStr.indexOf(e.charAt(h++))))<<4|(n=this.keyStr.indexOf(e.charAt(h++)))>>2,i=(3&n)<<6|(a=this.keyStr.indexOf(e.charAt(h++))),t+=String.fromCharCode(r<<2|o>>4),64!==n&&(t+=String.fromCharCode(s)),64!==a&&(t+=String.fromCharCode(i)),h<e.length;);return t}};leadingZero(e){return e<10?"0"+e:e}dynamicSort(s){let i=1;return"-"===s[0]&&(i=-1,s=s.substr(1)),function(e,t){return(e[s]<t[s]?-1:e[s]>t[s]?1:0)*i}}yesNo(e){return parseInt(e,10)<1?"No":"Yes"}isValidDate(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())}id(){return((100*Math.random()).toString()+(100*Math.random()).toString()).replace(/\./g,"")}tryCatch(e,t,s){var i={value:null};try{return e.apply(t,s)}catch(e){return i.value=e,i}}getNumberValue(e){return isNaN(Number(e))?Number(e.substring(0,e.length-2)):e}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}getOffset(e){e=e.getBoundingClientRect();return{top:e.top+document.body.scrollTop,left:e.left+document.body.scrollLeft}}debounce(i,r,o=!1){let n;return function(){let e=this,t=arguments;var s=o&&!n;clearTimeout(n),n=setTimeout(function(){n=null,o||i.apply(e,t)},r),s&&i.apply(e,t)}}}class Application extends Component{constructor(e){super(),this.options=this._initializeOptions(e),this.name=this.options.name,this.util=new Util,this.log=new LogManager(this),this.constants={},this.log.info("Application initializing...")}_initializeOptions(e){return{auth:{sessionTimeout:e?.auth?.sessionTimeout??9e5},console:e?.console?{enabled:e.console.enabled??!1,wsServer:e.console.wsServer??"",container:e.console.container??("object"==typeof gadgetui?gadgetui.display.FloatingPane:""),top:e.console.top??100,left:e.console.left??500,width:e.console.width??500,height:e.console.height??300}:{},events:e?.events??{},logging:{logLevel:e?.logging?.logLevel??"ERROR,FATAL,INFO",toBrowserConsole:e?.logging?.toBrowserConsole??!1},model:e?.model??"altseven",name:e?.name??"a7",remote:e?.remote?{loginURL:e.remote.loginURL??"",logoutURL:e.remote.logoutURL??"",refreshURL:e.remote.refreshURL??"",useTokens:e?.auth?.useTokens??!0,tokenType:e.remote.tokenType??"X-Token",modules:e.remote.modules??{}}:{useTokens:!0},router:e?.router?{options:{useEvents:e.router.useEvents??!0},routes:e.router.routes}:void 0,security:e?.security?{enabled:e.security.enabled??!0,options:e.security.options??{}}:{enabled:!0,options:{}},services:e?.services??[],ui:{enableMouseTracking:e?.ui?.enableMouseTracking??!1,mouseTrackingDeBounceTime:e?.ui?.mouseTrackingDeBounceTime??100,renderer:e?.ui?.renderer??("object"==typeof Mustache?"Mustache":"object"==typeof Handlebars?"Handlebars":"templateLiterals"),debounceTime:e?.ui?.debounceTime??18,timeout:e?.ui?.timeout??6e5},ready:!1}}async init(){if(this.log.trace("application log init"),this.log.trace("application services init"),this.services=new ServiceManager(this),this.log.trace("application dataproviders init"),this.dataproviders=new DataProviderManager(this),this.log.trace("application model init"),this.model=new ModelManager(this),this.model.set(this.options?.applicationName??"a7",this.options),this.options.console.enabled&&(this.log.trace("application console init"),this.console=new Console(this)),this.options.security.enabled&&(this.log.trace("application security init"),this.security=new SecurityManager(this)),this.log.trace("application remote init"),this.remote=new RemoteManager(this),this.log.trace("application events init"),this.events=new EventManager(this),this.options.router&&(this.log.trace("application router init"),this.router=new RouterManager(this)),this.log.trace("application ui init"),this.ui=new UIManager(this),this.options.security.enabled){this.log.trace("application security init"),this.security=new SecurityManager(this),this.error=new ErrorManager(this),0<this.options.services.length&&(this.options.services.forEach(e=>{this.services.register(e)}),this.log.trace("application services registered"));try{var e=await this.security.isAuthenticated();this.log.info(`Authenticated: ${e.authenticated}...`),this.authenticated=e.authenticated,this.user=e.user}catch(e){throw this.log.error("Authentication check failed:",e),e}}return this.log.info("Application initialized..."),this}}export{Component,DataProvider,Entity,Model,Service,User,View,Application};
//# sourceMappingURL=a7.min.js.map