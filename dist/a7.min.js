function Constructor(t,e,i){var s;return!0===i&&EventBindings.getAll().forEach(function(e){void 0===t.prototype[e]&&(t.prototype[e.name]=e.func)}),s=Object.create(t.prototype),!0===i&&(s.events={},void 0!==t.prototype.events)&&t.prototype.events.forEach(function(e){s.events[e]=[]}),i=void 0===(i=t.apply(s,e))?s:i}var EventBindings={on:function(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this},off:function(e){return this.events[e]=[],this},fireEvent:function(e,t){var i=this;void 0!==this.events[e]&&this.events[e].forEach(function(e){e(i,t)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};class Component{constructor(){this.events={}}on(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this}off(e){return this.events[e]=[],this}fireEvent(e,t){void 0!==this.events[e]&&this.events[e].forEach(e=>{e(this,t)})}getAll(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}}class DataProvider extends Component{#state={};#schema;#relations=new Map;constructor(e){super(),this.binding=e?.binding,this.#state=e.state,this.#schema=e.schema,this.view=e.view,this.id=this.view.props.id+"-dataProvider",this.services=new Map,this.bindings=new Map,this.serviceManager=null,this.log=null}set schema(e){}get schema(){return this.#schema}setServiceManager(e){this.serviceManager=e}setStateOnly(e){this.#state=Object.assign(this.#state,e)}setState(e){this.setStateOnly(e),this.fireEvent("stateChanged",e)}getState(){return Object.assign({},this.#state)}_validateRelationSchema(e){if(!this.#schema||!this.#schema[e])throw new Error(`Property "${e}" is not defined in DataProvider schema`);var t=this.#schema[e];if("entityMap"!==t.type)throw new Error(`Property "${e}" is not of type "entityMap" (found: ${t.type})`);if(!t.service)throw new Error(`Property "${e}" does not specify a service in schema`);if(t.fetchMethod)return t;throw new Error(`Property "${e}" does not specify a fetchMethod in schema`)}async _executeFetch(e,t,i=0){var s=this._validateRelationSchema(e);if(!this.serviceManager)throw new Error("ServiceManager not set on DataProvider. Ensure DataProvider is registered with DataProviderManager.");var r=this.serviceManager.getService(s.service);if(!r)throw new Error(`Service "${s.service}" not found for property "${e}"`);this.log&&this.log.trace(this.id+`: Fetching relation "${e}" with criteria:`,t);var t=await r.invoke(s.fetchMethod,t,{merge:!1,checkCache:!1});let o=[];if(Array.isArray(t))o=t;else if(t&&"object"==typeof t&&t.ids)o=t.ids;else{if(!t||"object"!=typeof t||!t.data)throw new Error(`fetchMethod "${s.fetchMethod}" returned unexpected format. Expected array or {ids: [...]}`);o=t.data}if(Array.isArray(o))return this.log&&this.log.debug(`${this.id}: Fetched ${o.length} IDs for relation "${e}"`),0===o.length?new Map:(t=await r.readMany(o),this.log&&this.log.debug(`${this.id}: Loaded ${t.size} entities for relation "${e}"`),t);throw new Error(`fetchMethod "${s.fetchMethod}" did not return an array of IDs`)}async loadRelation(e,t={},i={}){var i={merge:!1!==i.merge,returnData:i.returnData||!1},s=this._validateRelationSchema(e),t=Object.assign({},s.defaultCriteria||{},t),r=await this._executeFetch(e,t,i);if(this.#relations.set(e,{criteria:t,config:s}),i.merge&&this.#state[e]instanceof Map){let i=this.#state[e];r.forEach((e,t)=>{i.set(t,e)}),this.setState({[e]:i})}else this.setState({[e]:r});if(this.fireEvent("relationLoaded",{propertyName:e,criteria:t,count:r.size}),i.returnData)return r}async refresh(t,i={},e={}){var e={merge:!1!==e.merge,reload:e.reload||!1,returnData:e.returnData||!1},s=this.#relations.get(t);if(!s&&!e.reload)throw new Error(`Relation "${t}" has not been loaded yet. Use loadRelation() first or pass { reload: true }.`);let r;if(e.reload||!s){let e=this._validateRelationSchema(t);r=Object.assign({},e.defaultCriteria||{},i)}else r=Object.assign({},s.criteria,i);s=await this._executeFetch(t,r,e);let o=this._validateRelationSchema(t);if(this.#relations.set(t,{criteria:r,config:o}),e.merge&&this.#state[t]instanceof Map){let i=this.#state[t];s.forEach((e,t)=>{i.set(t,e)}),this.setState({[t]:i})}else this.setState({[t]:s});if(this.fireEvent("relationRefreshed",{propertyName:t,criteria:r,count:s.size}),e.returnData)return s}clearRelation(e){this.#relations.delete(e),this.setState({[e]:new Map}),this.fireEvent("relationCleared",{propertyName:e})}getRelationCriteria(e){e=this.#relations.get(e);return e?{...e.criteria}:null}}class Entity extends Component{static schema=null;_data;constructor(e){if(super(),this._data={},this.constructor.schema){for(var[t,i]of Object.entries(this.constructor.schema))if(i.required&&!(t in e)&&void 0===e[t])throw new Error("Missing required field: "+t);for(var[s,r]of Object.entries(this.constructor.schema))this._defineProperty(s);for(var[o,n]of Object.entries(this.constructor.schema))o in e&&void 0!==e[o]&&(this[o]=e[o]);this.validate()}let a=Object.keys(this.constructor.schema).find(e=>!0===this.constructor.schema[e].id);a&&!Object.prototype.hasOwnProperty.call(this,"id")&&Object.defineProperty(this,"id",{get:function(){return this[a]}})}get schema(){return this.constructor.schema}_getData(e){return this._data["_"+e]}_setData(e,t){var i=this.constructor.schema[e],s="_"+e;let r=typeof t;if(i.required&&void 0===t)throw new Error(`Property ${e} is required.`);if("date"===i.type&&"string"==typeof t){var o=new Date(t);if(isNaN(o))throw new Error(`Invalid date string for property ${e}: `+t);t=o,r="object"}if("boolean"!==i.type||"number"!=typeof t||1!==t&&0!==t||(t=1===t,r="boolean"),"object"!==i.type||!i.entityClass||null==t||t instanceof i.entityClass||(t=new i.entityClass(t)),!this._isOfType(t,i.type,i)&&null!=t)throw new Error(`Invalid type for property ${e}. Expected ${i.type}, but got ${r}.`);this._data[s]=t}_defineProperty(i){this._data["_"+i]=void 0;var s=Object.getOwnPropertyDescriptor(this.constructor.prototype,i);if(s&&(s.get||s.set)){let e=s.get,t=s.set;Object.defineProperty(this,i,{get:e?function(){return e.call(this)}:function(){return this._getData(i)},set:t?function(e){t.call(this,e)}:function(e){this._setData(i,e)}})}else Object.prototype.hasOwnProperty.call(this,i)||Object.defineProperty(this,i,{get:function(){return this._getData(i)},set:function(e){this._setData(i,e)}})}_isOfType(e,t,i){switch(t){case"date":return e instanceof Date&&!isNaN(e);case"array":return Array.isArray(e);case"boolean":return"boolean"==typeof e;case"integer":return Number.isInteger(e);case"float":return"number"==typeof e&&!Number.isInteger(e);case"string":return"string"==typeof e;case"object":return i?.entityClass?e instanceof i.entityClass:"object"==typeof e&&null!==e;default:return!0}}validate(){for(var e in this.constructor.schema){var t="_"+e;if(this.constructor.schema[e].required&&void 0===this._data[t])throw new Error(`Field ${e} is required`);if(this.constructor.schema[e].type&&null!=this._data[t]&&!this._isOfType(this._data[t],this.constructor.schema[e].type,this.constructor.schema[e]))throw new Error(`Field ${e} must be of type `+this.constructor.schema[e].type)}return!0}toFlatObject(){var e,t,i={};for([e,t]of Object.entries(this._data))i[e.replace(/^_/,"")]=t instanceof Entity?t.toFlatObject():t;return i}fromFlatObject(e){if(!e||"object"!=typeof e)throw new Error("Invalid input: expected an object");for(var[t,i]of Object.entries(e))this.constructor.schema&&this.constructor.schema[t]&&(this[t]=i);return this}}let Model=(()=>{let n=new Map,s=new Map,i=20,a;class r{constructor(e,t){this.data=this.processValue(e),this.elements=[],this.mementos=[],this.currentMementoIndex=-1,t&&this.bind(t),this.saveMemento()}handleEvent(e){if("change"===e.type){e.originalSource??="BindableObject.handleEvent[change]";for(var{elem:t,prop:i}of this.elements){var s;e.target.name===i&&"BindableObject.updateDomElement"!==e.originalSource&&(s=e.target.type.includes("select")?{id:e.target.value,text:e.target.options[e.target.selectedIndex].textContent}:e.target.value,this.change(s,e,i))}}}change(e,i,s){i.originalSource??="BindableObject.change",a.trace("change : Source: "+i.originalSource);let t=this.processValue(e);if(s){if("object"!=typeof this.data||null===this.data)throw new Error("Attempt to treat a simple value as an object with properties.");if(!(s in this.data))throw new Error(`Property '${s}' of object is undefined.`);this.data[s]=t}else this.data=t;this.saveMemento(),this.elements.filter(({prop:e,elem:t})=>(!s||s===e)&&t!==i.target).forEach(({elem:e})=>this.updateDomElement(i,e,t))}updateDom(i,s,r){i.originalSource??="BindableObject.updateDom",this.elements.forEach(({elem:e,prop:t})=>{r?t===r&&this.updateDomElement(i,e,s):"object"==typeof s&&null!==s?t in s&&this.updateDomElement(i,e,s[t]):this.updateDomElement(i,e,s)})}updateDomElement(e,s,t){e.originalSource??="BindableObject.updateDomElement";var i=()=>{s.innerHTML="";var e=Array.isArray(t)?t:t instanceof Map?Array.from(t.entries()):[t];"SELECT"===s.tagName?e.forEach((e,t)=>{var i=document.createElement("option");i.value="object"==typeof e?e.id??e[0]:e,i.textContent="object"==typeof e?e.text??e[1]:e,s.appendChild(i)}):["UL","OL"].includes(s.tagName)&&e.forEach(e=>{var t=document.createElement("li");t.textContent="object"==typeof e?e.text??e[1]:e,s.appendChild(t)})},r=["INPUT","TEXTAREA"].includes(s.tagName),o=["OL","UL","SELECT"].includes(s.tagName),n=["DIV","SPAN","H1","H2","H3","H4","H5","H6","P","LABEL","BUTTON","A","STRONG","EM","B","I","U","SMALL","SUB","SUP","Q","BLOCKQUOTE","CITE","CODE","PRE","ABBR","DFN","SAMP","KBD","VAR","LI","DT","DD","TH","TD","CAPTION","FIGCAPTION","SUMMARY","LEGEND","TITLE"].includes(s.tagName);"object"==typeof t&&null!==t?r?s.value=t.id??(t instanceof Map?"":t[0])??"":o?i():n&&(s.textContent=t.text??(t instanceof Map?"":t[1])??""):r?s.value=t??"":o?i():n&&(s.textContent=t??""),"model.set"!==e.originalSource&&"memento.restore"!==e.originalSource&&s.dispatchEvent(new Event("change",{originalSource:"model.updateDomElement"}))}bind(e,t){var i={elem:e,prop:t||""};e.value=t?this.data[t]:this.data,e.addEventListener("change",this),this.elements.push(i)}processValue(e){switch(typeof e){case"undefined":case"number":case"boolean":case"function":case"symbol":case"string":return e;case"object":return null===e?null:e instanceof Map?new Map(e):e;default:return e}}saveMemento(){this.currentMementoIndex<this.mementos.length-1&&this.mementos.splice(this.currentMementoIndex+1);var e=this.processValue(this.data);this.mementos.push(e),this.mementos.length>i?this.mementos.shift():this.currentMementoIndex++}undo(){return 0<this.currentMementoIndex&&(this.currentMementoIndex--,this.restoreMemento(),!0)}redo(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex++,this.restoreMemento(),!0)}rewind(){return 0<this.currentMementoIndex&&(this.currentMementoIndex=0,this.restoreMemento(),!0)}fastForward(){return this.currentMementoIndex<this.mementos.length-1&&(this.currentMementoIndex=this.mementos.length-1,this.restoreMemento(),!0)}restoreMemento(){this.data=this.processValue(this.mementos[this.currentMementoIndex]);let i={originalSource:"memento.restore"};this.elements.forEach(({elem:e,prop:t})=>{this.updateDomElement(i,e,t?this.data[t]:this.data)})}}return{BindableObject:r,init(e={},t){i=e.maxMementos??20,a=t},create(e,t,i){t=new r(t).processValue(t),t=new r(t,i);n.set(e,t),s.set(e,t)},destroy(e){n.delete(e),s.delete(e)},bind(e,t){var[e,i]=e.split("."),e=n.get(e);e&&e.bind(t,i)},exists(e){return n.has(e)},get(e,t){if(e){var[e,i]=e.split("."),s=n.get(e);if(s){if(!t)return(i=i?s.data[i]:s.data)instanceof Map?new Map(i):i;if(s.data instanceof Map){if(s.data.has(t))return s.data.get(t);a.trace(`Key '${t}' does not exist in the Map .`)}}else a.trace(`Key '${e}' does not exist in the model.`)}else a.error("Expected parameter [name] is not defined.")},set(e,t){if(e){var[e,i]=e.split("."),s={originalSource:"model.set"};if(n.has(e)){var r=n.get(e),o=r.processValue(t);r.change(o,s,i),r.updateDom(s,o,i)}else{if(i)throw new Error(`Object ${e} is not yet initialized.`);this.create(e,t)}}else a.error("Expected parameter [name] is not defined.")},undo(e){e=s.get(e);return!!e&&e.undo()},redo(e){e=s.get(e);return!!e&&e.redo()},rewind(e){e=s.get(e);return!!e&&e.rewind()},fastForward(e){e=s.get(e);return!!e&&e.fastForward()}}})();class Service extends Component{constructor(e){super(),this.id=e.id,this.key=e.key,this.remoteMethods=e.remoteMethods,this.entityClass=e.entityClass,this.dataProviders=new Map,this.bindings=new Map,this.log,this.model,this.remote,this.queue=new Map,this.idFields=this.getEntityIdFields(),this.fireEvent("mustRegister")}config(){this.set(new Map)}getEntityIdFields(){if(this.entityClass&&"object"==typeof this.entityClass.schema){var e,t,i=[];for([e,t]of Object.entries(this.entityClass.schema))!0===t.id&&i.push(e);return i}return[this.key]}setLog(e){this.log=e}setModel(e){this.model=e}setRemote(e){this.remote=e}registerDataProvider(e){this.dataProviders.set(e.id,e),e.log=this.log}convertArrayToMap(e){this.log.trace(this.id+": method: convertArrayToMap");let i=new Map;return e.forEach(e=>{var t=this.getCompositeKey(e);t&&i.set(t,e)}),i}convertMapToArray(e){return Array.from(e.values())}compareIDs(e){this.log.trace(this.id+": method: compareIDs"),this.log.debug(this.id+":compareIDs: "+e);let t=this.get(),i=[],s=[];return t instanceof Map?(e.forEach(e=>{(t.has(e)?i:s).push(e)}),this.log.debug(this.id+":results: "+JSON.stringify(i)+" "+JSON.stringify(s)),{present:i,missing:s}):{present:i,missing:e}}async merge(e){this.log.trace(this.id+": method: merge");let s=this.get(),r=(s instanceof Map||(s=new Map),[]),o=!1,n=!1;await Promise.all(e.map(async e=>{var t,i=this.getCompositeKey(e);i&&("create"==(t=s.has(i)?"update":"create")&&(o=!0),"update"==t&&(n=!0),e=await this.format(e),s.set(i,e),r.push({key:i,entity:e,action:t}))})),this.set(s);e=(!o||!n)&&o?"create":"update";return this.fireEvent("cacheChanged",{action:e}),r.forEach(({key:e,entity:t,action:i})=>{this.fireEvent("entityChanged",{id:e,entity:t,action:i})}),s}getCompositeKey(t){var e;return t&&"object"==typeof t?0===this.idFields.length?t[this.key]||null:1===this.idFields.length?t[this.idFields[0]]||null:0<(e=this.idFields.map(e=>t[e]).filter(e=>null!=e)).length?e.join("|"):null:null}bind(e,t){this.bindings.set(e,{filter:t})}async create(e){this.log.trace(this.id+": method: create");var e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.create,e)).json();return e.fromFlatObject(t),this.cacheSet(e,"create"),e}async read(r){this.log.trace(this.id+": method: read");let o=this.get(),n,a=this.remoteMethods.read+"-"+JSON.stringify(r);var e;return this.queue.has(a)?(this.log.debug(this.id+":Duplicate read request detected, waiting for existing request. "+JSON.stringify(r)),this.queue.get(a)):(this.log.debug(this.id+": New read request. "+JSON.stringify(r)),e=new Promise(async(e,t)=>{try{var i,s;n=this.getCompositeKey(r),o.has(n)||(i=r instanceof this.entityClass?r:await this.format(r),s=await(await this.remote.invoke(this.remoteMethods.read,i)).json(),i.fromFlatObject(s),this.cacheSet(await this.format(i))),e(this.get(n))}catch(e){this.log.debug(this.id+": Error reading object. "+e),t(e)}finally{this.queue.delete(a)}}),this.queue.set(a,e),this.log.debug(this.id+": read request added to the queue."),e)}async update(e){this.log.trace(this.id+": method: update");var e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.update,e)).json();return e.fromFlatObject(t),this.cacheSet(e,"update"),e}async delete(e){this.log.trace(this.id+": method: delete");var t={},e=e instanceof this.entityClass?e:await this.format(e),t=await(await this.remote.invoke(this.remoteMethods.delete,e)).json(),e=this.getCompositeKey(e);return this.cacheDelete(e),t}async readAll(s={}){this.log.trace(this.id+": method: readAll");let r=this.remoteMethods.readAll+"-"+JSON.stringify(s);var e;return this.queue.has(r)?(this.log.debug(this.id+":Duplicate readAll request detected, waiting for existing request."),this.queue.get(r)):(this.log.debug(this.id+":Creating new readAll request."),e=new Promise(async(e,t)=>{try{var i;this.get().size||(i=await(await this.remote.invoke(this.remoteMethods.readAll,s)).json(),await this.merge(i)),e(this.get())}catch(e){t(e)}finally{this.queue.delete(r)}}),this.queue.set(r,e),this.log.debug(this.id+":readAll completed for "+s.id),e)}async invoke(e,s,r={merge:!0,checkCache:!0,filter:{},returnType:"Map"}){this.log.trace(this.id+": method: invoke");let o=this.remoteMethods[e];if(!o)throw new Error(`Method ${e} not found in remoteMethods`);if(r?.checkCache){var t=this.get(),t=void 0===r.filter||void 0!==r.filter&&0===Object.keys(r.filter).length?t:this.filter(t,r.filter);if(0<t.length)return this.log.debug(this.id+": Cache hit for method",e),this.formatData(t,r.returnType)}let n=this.remoteMethods.invoke+`-${e}-`+JSON.stringify(s);return this.queue.has(n)?(this.log.debug(this.id+":Duplicate invoke request detected, waiting for existing request."),this.queue.get(n)):(this.log.debug(this.id+": New invoke: "+e),t=new Promise(async(e,t)=>{try{var i=await(await this.remote.invoke(o,s)).json();r.merge&&(Array.isArray(i)&&0<i.length?await this.merge(i):"object"==typeof i&&null!==i&&await this.merge([i]),e(await this.formatData(i,r.returnType))),e(i)}catch(e){t(e)}finally{this.queue.delete(n)}}),this.queue.set(n,t),this.log.debug(this.id+": Completed invoke: "+e),t)}async format(e){return this.log.trace(this.id+": method: format"),new this.entityClass(e)}async formatData(i,s){this.log.trace(this.id+": method: formatData");let r=new Map,o=[];var e;return"object"!=typeof i||Array.isArray(i)||null===i?"object"===s&&1===i.length?(e=i[0])instanceof this.entityClass?e:await this.format(e):(await Promise.all(i.map(async(e,t)=>{i[t]=e instanceof this.entityClass?e:await this.format(e),"Map"===s&&r.set(i[t].id,i[t]),"Array"===s&&o.push(i[t])})),"Map"===s?r:"Array"===s?o:void 0):this.format(i)}cacheDelete(e){this.log.trace(this.id+": method: cacheDelete");var t=this.get();t.delete(e),this.set(t),this.fireEvent("cacheChanged",{action:"delete"}),this.fireEvent("entityDeleted",{id:e,action:"delete"})}cacheSet(e,t="update"){if(this.log.trace(this.id+": method: cacheSet"),!(e instanceof this.entityClass))throw"Item must be of proper entity type.";var i=this.getCompositeKey(e);if(!i)throw new Error("Cannot cache item: no valid ID fields found");var s=this.get(),r=s.has(i);"update"!==t||r||(t="create"),s.set(i,e),this.set(s),this.fireEvent("cacheChanged",{action:t,item:e}),this.fireEvent("entityChanged",{id:i,entity:e,action:t})}set(e){this.log.trace(this.id+": method: set"),this.model.set(this.id,e)}get(e){return this.log.trace(this.id+": method: get"),void 0===e?this.model.get(this.id):this.model.get(this.id,e)}async readMany(n){if(this.log.trace(this.id+": method: readMany"),void 0===n)return new Map;let a=this.remoteMethods.readMany+"-"+JSON.stringify(n);var e;return this.queue.has(a)?(this.log.debug(this.id+":Duplicate readMany request detected, waiting for existing request."+n),this.queue.get(a)):(this.log.debug(this.id+": New readMany: "+n),e=new Promise(async(e,t)=>{try{var i,s,{present:r,missing:o}=this.compareIDs(n);this.log.debug(this.id+": Present? "+r.length),this.log.debug(this.id+": Missing? "+o.length),0<o.length&&(i={id:o},s=await(await this.remote.invoke(this.remoteMethods.readMany,i)).json(),Array.isArray(s))&&await this.merge(s),e(this.getMappedItems(n))}catch(e){t(e)}finally{this.queue.delete(a)}}),this.queue.set(a,e),this.log.debug(this.id+": Completed readMany: "+n),e)}getMappedItems(e){return this.log.trace(this.id+": method: getMappedItems"),e.map(e=>this.get(e)||null).filter(e=>null!==e)}sort(e,n){this.log.trace(this.id+": method: sort");e=e instanceof Map?Array.from(e.values()):e;if(n&&"object"==typeof n&&0!==Object.keys(n).length)return e.sort((e,t)=>{for(var i of Object.keys(n)){var s=n[i]||"asc",r=e[i],o=t[i];if(void 0!==r&&void 0!==o){if(typeof r!=typeof o)throw new Error(`Inconsistent types for sorting field '${i}'`);if("string"==typeof r)return i=r.localeCompare(o),"asc"===s?i:-i;if(r<o)return"asc"===s?-1:1;if(o<r)return"asc"===s?1:-1}}return 0}),e;throw new Error("Invalid sort fields provided")}filter(e,n){this.log.trace(this.id+": method: filter");e=Array.isArray(e)?e:Array.from(e.values());if(!n||"object"!=typeof n||0===Object.keys(n).length)throw new Error("Invalid filter criteria provided");let a=(e,t,i)=>{switch(i){case"=":return e===t;case"!=":return e!==t;case">":return t<e;case"<":return e<t;case">=":return t<=e;case"<=":return e<=t;case"∈":case"in":return Array.isArray(t)&&t.includes(e);case"∉":case"not in":return Array.isArray(t)&&!t.includes(e);default:throw new Error("Invalid operator: "+i)}};return e.filter(e=>{for(var t of Object.keys(n)){var i=n[t],t=e[t];if(Array.isArray(i)&&3===i.length){var[s,r,o]=i,r="function"==typeof r?r():r;if(o&&"string"==typeof r){o=new RegExp(r);if(!a(t.toString(),o.test(t),s))return!1}else if(!a(t,r,s))return!1}else if(Array.isArray(i)&&2===i.length){o=i[0],r="function"==typeof i[1]?i[1]():i[1];if("object"==typeof r&&Array.isArray(r)){if(!((e,t)=>{if(Array.isArray(t)&&2===t.length)return e>=t[0]&&e<=t[1];throw new Error("Range must be an array with two elements")})(t,r))return!1}else if(!a(t,r,o))return!1}else if(!a(t,i,"="))return!1}return!0})}}class User extends Component{constructor(e){super(),Object.assign(this,e)}getMemento(){let t={},i=this;return Object.keys(this).forEach(e=>{t[e]=i[e]}),t}}class View extends Component{constructor(e){super(),this.type="View",this.timeout=6e5,this.renderer="templateLiterals",this.debounceTime=18,this.timer,this.element,this.props=e,this.log,this.model,this.ui,this.isTransient=e.isTransient||!1,this.state={},this.skipRender=!1,this.children={},this.components={},this.templateCache=null,this.fireEvent("mustRegister")}setLog(e){this.log=e}setModel(e){this.model=e}setUI(e){this.ui=e}setRenderer(e){this.renderer=e}setTimeout(e){this.timeout=e}setDebounce(e){this.debounce=e}setDebounceTime(e){this.debounceTime=e}config(){this.on("mustRender",this.debounce(function(){this.log.trace("mustRender: "+this.props.id),this.shouldRender()?this.ui.enqueueForRender(this.props.id):(this.log.trace("Render cancelled: "+this.props.id),this.skipRender=!1)}.bind(this),this.debounceTime)),this.on("rendered",function(){this.isTransient&&(void 0!==this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.checkRenderStatus.bind(this),this.timeout)),this.onRendered()}.bind(this)),this.on("registered",function(){void 0!==this.props.parentID&&!this.mustRender||this.fireEvent("mustRender")}.bind(this)),this.on("mustUnregister",function(){this.ui.unregister(this.props.id)}.bind(this))}setState(e){this.templateCache=null,this.dataProvider?(this.dataProvider.setState(e),this.log.debug("setState using dataProvider for ",this.props.id)):(this.log.debug("setState for ",this.props.id),this.state=Object.assign(this.state,e),this.fireEvent("stateChanged",e)),this.fireEvent("mustRender")}getState(){return this.dataProvider?this.dataProvider.getState():Object.assign(this.state)}registerDataProvider(e){this.dataProvider=e,this.dataProvider.on("stateChanged",(e,t)=>{this.fireEvent("stateChanged",t)})}unregisterDataProvider(){this.dataProvider=null}addChild(e){this.children[e.props.id]=e}removeChild(e){delete this.children[e.props.id]}clearChildren(){this.children={}}getParent(){return this.props.parentID?this.ui.getView(this.props.parentID):void 0}render(){if(this.log.trace("render: "+this.props.id),null==this.element&&(this.element=document.querySelector(this.props.selector)),this.element){let e="";null!==this.templateCache&&this.ui.options.ui.cacheTemplates?(e=this.templateCache,this.log.debug("Using cached template for view "+this.props.id)):(this.log.debug("Rendering template for view "+this.props.id),e="function"==typeof this.template?this.template():this.template,this.templateCache=e),this.element.innerHTML=e;var t=[];this.ui.getEvents().forEach(function(e){t.push("[data-on"+e+"]")}),this.element.querySelectorAll(t.toString()).forEach(function(e){for(var t=0;t<e.attributes.length;t++){var i=e.attributes[t];i.name.startsWith("data-on")&&(i=i.name.substring(7,i.name.length),e.addEventListener(i,this.eventHandlers[e.attributes["data-on"+i].value]))}}.bind(this)),this.element.querySelectorAll("[data-bind]").forEach(function(e){this.model.bind(e.attributes["data-bind"].value,e)}),this.log.trace("Rendered: "+this.props.id),this.fireEvent("rendered")}else this.log.trace("The DOM element for view "+this.props.id+" was not found. The view will be removed and unregistered."),void 0!==this.props.parentID&&this.ui.getView(this.props.parentID).removeChild(this),this.fireEvent("mustUnregister")}shouldRender(){return!this.skipRender}onRendered(){for(var e in this.children)this.children[e].element=document.querySelector(this.children[e].props.selector),this.children[e].render()}checkRenderStatus(){null===document.querySelector(this.props.selector)?this.ui.unregister(this.id):this.isTransient&&(this.timer=setTimeout(this.checkRenderStatus.bind(this),this.timeout))}}class Console extends Component{constructor(e){super(),this.title="Console Window",this.consoleDiv=null,this.active=!1,this.app=e,this.resolve=resolve,this.reject=reject,this.options=this.app.options.console,this.options.enabled?(this.active=!0,this.consoleDiv=document.createElement("div"),this.consoleDiv.setAttribute("id","a7consoleDiv"),this.consoleDiv.setAttribute("class","a7-console"),document.body.appendChild(this.consoleDiv),(e=new this.options.container(this.consoleDiv,{width:this.options.width,left:this.options.left,height:this.options.height,title:this.title,top:this.options.top,enableShrink:!0,enableClose:!0})).element&&e.element.setAttribute("right",0),this.options.wsServer&&a7.remote.webSocket(this.options.wsServer,this.handleMessage.bind(this)),a7.console.addMessage=this.addMessage.bind(this),a7.log.info("Console initializing..."),this.resolve()):this.reject("Console init should not be called when console option is set to false.")}addMessage(e,t,i,s){var r=document.createElement("div");r.setAttribute("class","a7-console-row-"+i),void 0!==s&&(r.innerHTML=s+": ",r.setAttribute("class",r.getAttribute("class")+" a7-console-row-"+s)),r.innerHTML+=+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+": "+e,this.consoleDiv.appendChild(r)}handleMessage(e,t){var i=0;if("history"===t.type)for(i=0;i<t.data.length;i++)this.addMessage(t.data[i].text,new Date(t.data[i].time),"websocket");else"message"===t.type?this.addMessage(t.data.text,new Date(t.data.time),"websocket"):a7.log.error("This doesn't look like valid JSON: ",t)}}class DataProviderManager extends Component{constructor(e){super(),this.app=e,this.services=this.app.services.getAll(),this._dataproviders=new Map,e.log.info("DataProviderManager initialized...")}getDataProvider(e){return this._dataproviders.get(e)}getAll(){return this._dataproviders}register(t){this._dataproviders.set(t.id,t),t.setServiceManager(this.app.services),this.bind(t),this.services.forEach(e=>{e.registerDataProvider(t)}),this.app.log.trace(`DataProvider "${t.id}" registered.`)}bind(r){if(r.binding)for(let s in r.binding){var e=r.binding[s].dependencies||null,t=[...this.services.values()].find(e=>e.entityClass===r.binding[s].entityClass);if(t){this.app.log.trace("Binding: ",s);var o=r.binding[s].filter||null,n=r.binding[s].func||null,a=r.binding[s].sort||null;let i=r.binding[s].id||null;var h=r.binding[s].renderOn||null,a=(r.bindings.set(s,{key:s,service:t,filter:o,sort:a,func:n,dependencies:e,id:i,renderOn:h}),t.bind(s,o),this.getBoundData(r,r.bindings.get(s)));r.setStateOnly({[s]:a}),null!==i?(t.on("entityChanged",(e,t)=>{t.id===i&&(this.app.log.trace(`Entity ${i} changed, updating DataProvider `+r.id),r.view.setState({[s]:t.entity}))}),t.on("entityDeleted",(e,t)=>{t.id===i&&(this.app.log.trace(`Entity ${i} deleted, clearing DataProvider `+r.id),r.view.setState({[s]:null}))})):t.on("cacheChanged",(e,t)=>{var i=r.bindings.get(s);null!==i.renderOn&&Array.isArray(i.renderOn)&&!i.renderOn.includes(t.action)?this.app.log.trace(`Skipping render for action "${t.action}" (renderOn: ${i.renderOn})`):(t.state=r.getState(),this.updateBoundState(r,i,t))})}(e=r.binding[s].dependencies||[]).forEach(e=>{let i=e.split(".");1===i.length?r.on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[i]in t&&(this.app.log.trace("updated "+i),this.updateBoundState(r,r.bindings.get(s),{action:"refresh",state:r.getState()}))}):2===i.length&&this.app.ui.getView(i[0]).on("stateChanged",(e,t)=>{this.app.log.trace("Binding dependency"),[i[1]]in t&&(this.app.log.trace("updated "+i[1]),this.updateBoundState(r,r.bindings.get(s),{action:"refresh",state:r.getState(),dependentState:e.getState()}))})})}}getBoundData(e,t){let i;e=e.schema[t.key].type;return"object"===e?i=t.service.get(t.id):"map"===e&&(i=t.service.get(),null!==t.filter&&(i=t.service.filter(i,t.filter)),null!==t.sort)&&(i=t.service.sort(i,t.sort)),i}async updateBoundState(t,i,s){let e;if(null!==i.func){s=Object.assign(s,{filter:i.filter,sort:i.sort}),e="AsyncFunction"===i.func.constructor.name?await i.func(s,t):i.func(s,t);var r=t.schema[i.key].type;null!==i.sort&&(e=e&&i.service.sort(e,i.sort)),"map"===r&&Array.isArray(e)&&(e=i.service.convertArrayToMap(e)),t.view.setState({[i.key]:e})}else{var r=t.view.getState(),o=t.schema[i.key].type;let e=!1;(e="map"===o||("object"===o?s.item&&r[i.key]&&r[i.key].id===s.item.id:"object"!=typeof r[i.key]))&&(o=this.getBoundData(t,i),t.view.setState({[i.key]:o}))}}}class ErrorManager extends Component{constructor(e){super(),this.app=e,window.onerror=(e,t,i,s,r)=>(this.captureError(e,t,i,s,r),!1),e.log.info("ErrorManager initialized...")}captureError(e,t,i,s,r){var o;-1<e.toLowerCase().indexOf("script error")?this.app.log.error("Script Error: See Browser Console for Detail"):(o=["Message: "+e,"URL: "+t,"Line: "+i,"Column: "+s,"Error object: "+JSON.stringify(r)].join(" - "),this.fireEvent("scriptError",[e,t,i,s,r]),this.app.log.error(o))}}class EventManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,this.topics={},this.hasProp=this.topics.hasOwnProperty,this.subscribe("auth.login",e=>{this.app.remote.invoke("auth.login",e)}),this.subscribe("auth.logout",e=>{this.app.remote.invoke("auth.logout",e)}),this.subscribe("auth.refresh",e=>{this.app.remote.invoke("auth.refresh",e)}),this.subscribe("auth.sessionTimeout",()=>{this.app.security.invalidateSession()}),this.subscribe("auth.invalidateSession",()=>{this.app.security.invalidateSession()});for(var[t,i]of Object.entries(this.options.events))this.subscribe(t,i)}subscribe(e,t){this.hasProp.call(this.topics,e)||(this.topics[e]=[]);var i=this.topics[e].push(t)-1;return{remove:()=>{delete this.topics[e][i]}}}publish(e,t){this.app.log.trace("event: "+e),this.hasProp.call(this.topics,e)&&this.topics[e].forEach(function(e){e(t||{})})}}class LogManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,this._ready=!1,this._deferred=[],this.logLevel=this.options.logging.logLevel,this._toBrowserConsole=this.options.logging.toBrowserConsole,this._consoleEnabled=this.options.console.enabled,this._ready=!0,this._deferred.forEach(e=>{this.log(e.message,e.level)}),this._deferred=[],this.info("Log initializing..."),this.fireEvent("initialized")}error(e){this.log(e,"ERROR")}fatal(e){this.log(e,"FATAL")}info(e){this.log(e,"INFO")}trace(e){this.log(e,"TRACE")}debug(e){this.log(e,"DEBUG")}warn(e){this.log(e,"WARN")}log(e,t){this._ready&&0<=this.logLevel.indexOf(t)||0<=this.logLevel.indexOf("ALL")?(this._consoleEnabled&&a7.console.addMessage(e,new Date,"local",t),this._toBrowserConsole&&console.log(e)):this._ready||this._deferred.push({message:e,level:t})}}class ModelManager extends Component{constructor(e){if(super(),this.app=e,this.options=this.app.options,this._model=null,this._methods={},e.log.info("Model initializing... "),"string"==typeof this.options.model)switch(this.options.model){case"altseven":this._model=Model,this._model.init(this.options,this.app.log);break;case"gadgetui":this._model=gadgetui.model}else"object"==typeof this.options.model&&(this._model=this.options.model);e.log.trace("Model set: "+this._model),Object.keys(this._model).forEach(e=>{this._methods[e]=this._model[e]})}destroy(...e){return this._methods.destroy.apply(this._model,e)}get(...e){return this._methods.get.apply(this._model,e)}set(...e){return this._methods.set.apply(this._model,e)}exists(...e){return this._methods.exists.apply(this._model,e)}bind(...e){return this._methods.bind.apply(this._model,e)}undo(...e){return this._methods.undo.apply(this._model,e)}redo(...e){return this._methods.redo.apply(this._model,e)}rewind(...e){return this._methods.rewind.apply(this._model,e)}fastForward(...e){return this._methods.fastForward.apply(this._model,e)}}class RemoteManager extends Component{constructor(e){super(),this.connections={},this.app=e,this.options=e.options.remote||{},this.time=new Date,this.sessionTimer,this.modules={},this.init(this.options.modules),this.token,e.log.trace("RemoteManager initializing... ")}setModule(e,t){this.modules[e]=t}webSocket(e,t,i=!1){let s;var r;s=e.startsWith("ws://")||e.startsWith("wss://")?(r=new URL(e),this.options.useTokens&&r.searchParams.set("token",this.token),r.toString()):(i?"wss://":"ws://")+e.replace(/\/+$/,""),this.app.log.trace("WebSocket connecting to:",s);let o=new WebSocket(s);return o.onopen=()=>{this.app.log.trace(`WebSocket connection to ${s} established...`),this.fireEvent("webSocketOpen",[o])},o.onerror=e=>{var t;console.error("WebSocket connection failed:",e),s.endsWith("/")&&(t=s.slice(0,-1),this.app.log.trace("Trying alternative URL:",t)),this.app.log.error("WebSocket error:",e),this.fireEvent("webSocketError",[e])},o.onclose=()=>{this.app.log.trace(`WebSocket connection to ${s} closed.`),this.fireEvent("webSocketClose",[])},o.onmessage=async e=>{e=JSON.parse(e.data);this.app.log.trace("Received message:",e),"AsyncFunction"===t.constructor.name?await t(e):t(e),this.fireEvent("webSocketMessage",[e])},this.connections[s]=o}getConnection(e){return this.connections[e]}closeConnection(e){this.connections[e]&&(this.connections[e].close(),delete this.connections[e],this.app.log.trace(`WebSocket connection to ${e} closed.`))}closeAllConnections(){for(var e in this.connections)this.closeConnection(e)}async refreshClientSession(){try{await this.invoke("auth.refresh",{resolve:e=>{e.authenticated?this.app.log.trace("Still logged in."):(this.app.log.trace("Session expired."),this.app.events.publish("auth.logout"))},reject:e=>{this.app.log.error("Error in refreshClientSession:",e),this.app.events.publish("auth.logout")}})}catch(e){this.app.log.error("Error in refreshClientSession:",e),this.app.events.publish("auth.logout")}}setToken(e){sessionStorage.token=e,this.token=e}getToken(){return this.token}invalidateToken(){this.setToken("")}getSessionTimer(){return this.sessionTimer}init(t){var e=this.app.options.auth,e=(this.options.sessionTimeout=e.sessionTimeout,this.options.useTokens&&sessionStorage.token&&""!==sessionStorage.token&&(this.token=sessionStorage.token),{login:async e=>{this.app.log.trace("remote call: auth.login");var i={method:"POST",headers:{Authorization:"Basic "+this.app.util.base64.encode64(e.username+":"+e.password),Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify({rememberMe:e.rememberMe||!1})};this.options.credentials&&(i.credentials=this.options.credentials);try{var s,r,o=await fetch(this.options.loginURL,i);this.options.useTokens&&null!=(s="X-Token"===this.options.tokenType?o.headers.get("X-Token"):o.headers.get("Access_token"))&&this.setToken(s);let t=await o.json();t.success?(r=this.app.model.get("user"),Object.keys(t.user).map(e=>{r[e]=t.user[e]}),sessionStorage.user=JSON.stringify(r),this.app.model.set("user",r),this.app.log.trace("User set into model:",r),void 0!==e.success&&("function"==typeof e.success?e.success(t):this.app.options.router?this.app.router.open(e.success,t):this.app.events.publish(e.success,t))):void 0!==e.failure&&("function"==typeof e.failure?e.failure(t):this.app.options.router?this.app.router.open(e.failure,t):this.app.events.publish(e.failure,t)),void 0!==e.callback&&e.callback(t)}catch(e){this.app.log.error("Login error:",e)}},logout:async e=>{this.app.log.trace("remote call: auth.logout");var t={method:"POST",headers:{}};this.options.credentials&&(t.credentials=this.options.credentials);try{var i=await(await fetch(this.options.logoutURL,t)).json();i.success?(this.app.security.invalidateSession(),void 0!==e.success&&("function"==typeof e.success?e.success(i):this.app.options.router?this.app.router.open(e.success,i):this.app.events.publish(e.success,i))):void 0!==e.failure&&("function"==typeof e.failure?e.failure(i):this.app.options.router?this.app.router.open(e.failure,i):this.app.events.publish(e.failure,i)),void 0!==e.callback&&e.callback()}catch(e){this.app.log.error("Logout error:",e)}},refresh:async t=>{try{var i={},s=(this.options.credentials&&(i.credentials=this.options.credentials),await this.fetch(this.options.refreshURL,i,!0));let e;e=401===s.status?{isauthenticated:!1}:await s.json(),void 0!==t.resolve&&t.resolve(e)}catch(e){t.reject&&t.reject(e)}}});this.setModule("auth",e),Object.keys(t).forEach(e=>{this.setModule(e,t[e])})}async fetch(e,t,i){if(this.app.log.trace("fetch: "+e),i&&this.options.useTokens){var s=new Date,r=Math.abs(s-this.time);if(Math.floor(r/1e3/60)>this.options.sessionTimeout)return void this.app.events.publish("auth.sessionTimeout");null!=this.token&&(void 0===t.headers?"X-Token"===this.options.tokenType?t.headers={"X-Token":this.token}:t.headers={Authorization:"Bearer "+this.getToken()}:"X-Token"===this.options.tokenType?t.headers["X-Token"]=this.token:t.headers.Authorization="Bearer "+this.getToken()),this.time=s}this.options.credentials&&(t.credentials=this.options.credentials),r=new Request(e,t);try{var o,n=await fetch(r);return i&&this.options.useTokens&&(null!=(o="X-Token"===this.options.tokenType?n.headers.get("X-Token"):n.headers.get("Access_token"))?(this.setToken(o),void 0!==this.sessionTimer&&clearTimeout(this.sessionTimer),this.sessionTimer=setTimeout(()=>{this.refreshClientSession()},this.options.sessionTimeout)):this.app.events.publish("auth.sessionTimeout")),n}catch(e){throw this.app.log.error(e),e}}async genericFetch(e,t,i=null,s={}){e={method:e,headers:s};return i&&(e.body=JSON.stringify(i)),this.fetch(t,e,!0)}async readAll(e){return this.genericFetch("GET",e.url)}async create(e,t){return this.genericFetch("POST",e.url,t,{Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"})}async read(e,t){let i=e.url;return Object.keys(t).forEach(e=>{i=i.replace(new RegExp(":"+e,"g"),t[e])}),this.genericFetch("GET",i)}async update(e,t){let i=e.url;Object.keys(t).forEach(e=>{i=i.replace(new RegExp(":"+e,"g"),t[e])});return this.genericFetch("PUT",i,t,{Accept:"application/json, application/xml, text/play, text/html, *.*","Content-Type":"application/json; charset=utf-8"})}async destroy(e,t){let i=e.url;return Object.keys(t).forEach(e=>{i=i.replace(new RegExp(":"+e,"g"),t[e])}),this.genericFetch("DELETE",i)}async invoke(e,t){e=e.split(".");if(e.length<2)this.app.log.error("No action specified. Valid actions are: "+Object.keys(this.modules[e[0]]).toString());else{var i=e[0],e=e[1];if("function"==typeof this.modules[i][e])return this.modules[i][e](t);if("object"==typeof this.modules[i][e]){var s=this.modules[i][e];switch(e){case"read":return this.read(s,t.toFlatObject());case"readAll":return this.readAll(s);case"create":return this.create(s,t.toFlatObject());case"update":return this.update(s,t.toFlatObject());case"destroy":return this.destroy(s,t.toFlatObject());default:return this.invokeCustomMethod(s,t)}}else this.app.log.error("Invalid action: "+e)}}async invokeCustomMethod(e,t){var i=e.params&&e.params.method||"GET";let s=e.url;"object"==typeof t&&null!==t&&Object.keys(t).forEach(e=>{s=s.replace(new RegExp(":"+e,"g"),t[e])});var r={};let o=null;t.body&&(o=JSON.stringify(t.body),r["Content-Type"]="application/json; charset=utf-8"),e.params&&e.params.headers&&Object.assign(r,e.params.headers);e={method:i.toUpperCase(),headers:r};return o&&(e.body=o),this.fetch(s,e,!0)}}class RouterManager extends Component{constructor(e,t){super(),this.app=e,this.router=new Router(e.options.router.routes),this.useEvents=this.app.options.router.useEvents??!1,window.onpopstate=e=>{this.match(document.location.pathname+document.location.search)},e.log.info("RouterManager initialized...")}add(e,t){return this.router.add(e,t),this}find(e){return this.router.find(e)}open(e,t={}){var i=this.find(e);i&&i.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},i.params||{}),this.useEvents&&"string"==typeof i.handler?this.app.events.publish(i.handler,t):i.handler(t)):this.app.log.error("No route found for path: "+e)}match(e,t={}){var i=this.find(e);i&&i.handler?(history.pushState(JSON.parse(JSON.stringify(t)),"",e),t=Object.assign(t||{},i.params||{}),this.useEvents?this.app.events.publish(i.handler,t):i.handler(t)):this.app.log.error("No route found for path: "+e)}}class Router{constructor(e){this.REGEX_PARAM_DEFAULT=/^[^/]+/,this.REGEX_START_WITH_PARAM=/^(:\w|\()/,this.REGEX_INCLUDE_PARAM=/:\w|\(/,this.REGEX_MATCH_PARAM=/^(?::(\w+))?(?:\(([^)]+)\))?/,this.root=this.createNode(),e&&e.forEach(e=>this.add.apply(this,e))}createNode(e={}){var{regex:e=null,param:t=null,handler:i=null}=e;return{regex:e,param:t,handler:i,children:{string:{},regex:{}}}}add(e,t){return this.parseOptim(e,t,this.root),this}parse(t,i,s){if(this.REGEX_START_WITH_PARAM.test(t)){var r=t.match(this.REGEX_MATCH_PARAM);let e=s.children.regex[r[0]];e=e||(s.children.regex[r[0]]=this.createNode({regex:r[2]?new RegExp("^"+r[2]):this.REGEX_PARAM_DEFAULT,param:r[1]})),r[0].length===t.length?e.handler=i:this.parse(t.slice(r[0].length),i,e)}else{r=t[0];let e=s.children.string[r];e=e||(s.children.string[r]=this.createNode()),this.parse(t.slice(1),i,e)}}parseOptim(e,t,i){var s;this.REGEX_INCLUDE_PARAM.test(e)?this.parse(e,t,i):(s=i.children.string[e])?s.handler=t:i.children.string[e]=this.createNode({handler:t})}find(e){return this.findOptim(e,this.root,{})}findOptim(e,t,i){var s=t.children.string[e];return s&&void 0!==s.handler?{handler:s.handler,params:i}:this._find(e,t,i)}_find(e,t,i){var s,r=t.children.string[e[0]];if(r){r=this._find(e.slice(1),r,i);if(r)return r}for(s in t.children.regex){var o=t.children.regex[s],n=e.match(o.regex);if(n){if(n[0].length===e.length&&void 0!==o.handler)return o.param&&(i[o.param]=decodeURIComponent(n[0])),{handler:o.handler,params:i};var a=this.findOptim(e.slice(n[0].length),o,i);if(a)return o.param&&(i[o.param]=decodeURIComponent(n[0])),a}}return null}}class SecurityManager extends Component{constructor(e){super(),this.app=e,this.options=e.options,e.log.info("Security initializing..."),this.useModel=0<this.options.model.length,this.userArgs=this.options.security.userArgs||{};e=this.getUser();this.setUser(e)}async isAuthenticated(){return this.app.log.trace("Checking authenticated state.. "),this.authRefreshPromise?this.app.log.trace("Waiting for existing auth.refresh call to complete"):this.authRefreshPromise=new Promise(async(e,t)=>{try{var i=await this.app.remote.invoke("auth.refresh",{resolve:e,reject:t});i.authenticated&&this.setUser(i.user),this.app.log.trace("Resolving the response... "),e(i)}catch(e){t(e)}finally{this.authRefreshPromise=null}}),this.authRefreshPromise}invalidateSession(){clearTimeout(this.app.remote.getSessionTimer()),this.app.remote.invalidateToken();var e=new User(this.userArgs);this.setUser(e)}setUser(e){this.useModel&&this.app.model.set("user",e),sessionStorage.user=JSON.stringify(e)}getUser(){let t,i;var e=this.useModel?this.app.model.get("user"):null;if(void 0!==e&&""!==e&&null!==e)i=e;else if(void 0!==sessionStorage.user&&""!==sessionStorage.user)try{t=JSON.parse(sessionStorage.user),i=new User(this.userArgs),Object.keys(t).map(e=>i[e]=t[e])}catch(e){console.error("Error parsing user data:",e),i=new User(this.userArgs)}else i=new User(this.userArgs);return i}}class ServiceManager extends Component{constructor(e){super(),this.app=e,this.services=new Map}getService(e){return this.services.get(e)}getAll(){return this.services}register(e){this.services.set(e.id,e),e.setLog(this.app.log),e.setModel(this.app.model),e.setRemote(this.app.remote),e.config(),this.app.log.trace("Service registered: "+e.id)}}class UIManager extends Component{#handleMouseMove(e){this.mousePosition={x:e.clientX,y:e.clientY}}#debouncedMouseMove;constructor(e){super(),this.app=e,this.options=e.options,this.events=[],this.selectors={},this.nodes={},this.queue=[],this.deferred=[],this.stateTransition=!1,this.mousePosition={x:0,y:0},this.views=[],e.log.trace("Layout initializing...");e=this.options.ui.eventGroups||"standard";switch(this.config(),e){case"extended":break;case"standard":this.events=this.standardEvents;break;default:this.options.ui.eventGroups.forEach(e=>this.events.concat(e))}this.options.ui.enableMouseTracking&&this.enableMouseTracking(!0)}config(){this.standardEvents=["cached","error","abort","load","beforeunload"].concat(["online","offline"]).concat(["focus","blur"]).concat(["open","message","error","close"]).concat(["pagehide","pageshow","popstate"]).concat(["animationstart","animationend","animationiteration"]).concat(["transitionstart","transitioncancel","transitionend","transitionrun"]).concat(["reset","submit"]).concat(["beforeprint","afterprint"]).concat(["compositionstart","compositionupdate","compositionend"]).concat(["fullscreenchange","fullscreenerror","resize","scroll"]).concat(["cut","copy","paste"]).concat(["keydown","keypress","keyup"]).concat(["auxclick","click","contextmenu","dblclick","mousedown","mousenter","mouseleave","mousemove","mouseover","mouseout","mouseup","pointerlockchange","pointerlockerror","wheel"]).concat(["drag","dragend","dragstart","dragleave","dragover","drop"]).concat(["audioprocess","canplay","canplaythrough","complete","durationchange","emptied","ended","loadeddata","loadedmetadata","pause","play","playing","ratechange","seeked","seeking","stalled","suspend","timeupdate","columechange","waiting"]).concat(["loadend","loadstart","progress","timeout"]).concat(["change","storage"]).concat(["checking","downloading","noupdate","obsolete","updateready"]).concat(["broadcast","CheckBoxStateChange","hashchange","input","RadioStateChange","readystatechange","ValueChange"]).concat(["invalid","localized","show"])}enableMouseTracking(e){e?(this.#debouncedMouseMove=this.app.util.debounce(this.#handleMouseMove.bind(this),this.options.ui.mouseTrackingDeBounceTime),document.addEventListener("mousemove",this.#debouncedMouseMove)):document.removeEventListener("mousemove",this.#debouncedMouseMove)}setSelector(e,t){this.selectors[e]=t,this.nodes[e]=document.querySelector(t)}getSelector(e){return this.selectors[e]}getNode(e){return this.nodes[e]}getView(e){return this.views[e]}setStateTransition(e){this.stateTransition=e,this.app.log.trace("this.app.ui.stateTransition: "+e)}getStateTransition(){return this.stateTransition}getEvents(){return this.events}register(e){switch(this.options.ui.renderer){case"Handlebars":case"Mustache":case"templateLiterals":e.setLog(this.app.log),e.setModel(this.app.model),e.setUI(this.app.ui),e.setTimeout(this.app.options.ui.timeout),e.setDebounceTime(this.app.options.ui.debounceTime),e.setRenderer(this.app.options.ui.renderer),e.setDebounce(this.app.util.debounce),e.config(),this.views[e.props.id]=e,this.getView(e.props.parentID)&&this.getView(e.props.parentID).addChild(e),e.fireEvent("registered")}}unregister(e){delete this.views[e]}getParentViewIds(e){this.app.log.trace("Find parents of "+e);var t=[];let i=this.views[e];for(;void 0!==i.props.parentID;)t.unshift(i.props.parentID),i=this.views[i.props.parentID];return t}getChildViewIds(e){this.app.log.trace("Find children of "+e);var t,i=[],s=this.views[e];for(t in s.children){var r=s.children[t].props.id;void 0!==this.getView(r)&&(i.push(r),i.concat(this.getChildViewIds(r)))}return i}enqueueForRender(t){if(this.getStateTransition())this.deferred.push(t);else if(this.app.log.trace("enqueue: "+t),this.queue.length){var e=this.getChildViewIds(t);if(void 0===this.views[t].props.parentID)this.app.log.trace("add to front of queue: "+t),this.queue.unshift(t);else{var i=this.getParentViewIds(t);let e=void 0;void 0===(e=i.length?i.find(e=>0<=this.queue.indexOf(e)):e)&&(this.app.log.trace("add to end of queue: "+t),this.queue.push(t))}e.forEach(e=>{0<=this.queue.indexOf(e)&&(this.app.log.trace("remove child from queue: "+e),this.queue.splice(this.queue.indexOf(e),1))})}else this.app.log.trace("add first view to queue: "+t),this.queue.push(t),this.processRenderQueue()}processRenderQueue(){this.app.log.trace("processing the queue"),this.setStateTransition(!0);try{this.queue.forEach(e=>{this.app.log.debug("view ID: "+e),this.views[e]?this.views[e].render():this.app.log.warn("View not found: "+e)})}catch(e){this.app.log.error(e)}this.queue=[],this.setStateTransition(!1),this.deferred.forEach(e=>this.enqueueForRender(e)),this.deferred=[]}removeView(e){delete this.views[e]}}class Util{constructor(){}split(e){return e.split(/,\s*/)}extractLast(e){return this.split(e).pop()}base64={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64(e){if(!String(e).length)return!1;let t="",i,s,r,o,n,a,h,c=0;for(;i=e.charCodeAt(c++),s=e.charCodeAt(c++),r=e.charCodeAt(c++),o=i>>2,n=(3&i)<<4|s>>4,a=(15&s)<<2|r>>6,h=63&r,isNaN(s)?a=h=64:isNaN(r)&&(h=64),t=t+this.keyStr.charAt(o)+this.keyStr.charAt(n)+this.keyStr.charAt(a)+this.keyStr.charAt(h),c<e.length;);return t},decode64(e){if(!e)return!1;let t="",i,s,r,o,n,a,h=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");r=this.keyStr.indexOf(e.charAt(h++)),i=(15&(o=this.keyStr.indexOf(e.charAt(h++))))<<4|(n=this.keyStr.indexOf(e.charAt(h++)))>>2,s=(3&n)<<6|(a=this.keyStr.indexOf(e.charAt(h++))),t+=String.fromCharCode(r<<2|o>>4),64!==n&&(t+=String.fromCharCode(i)),64!==a&&(t+=String.fromCharCode(s)),h<e.length;);return t}};leadingZero(e){return e<10?"0"+e:e}dynamicSort(i){let s=1;return"-"===i[0]&&(s=-1,i=i.substr(1)),function(e,t){return(e[i]<t[i]?-1:e[i]>t[i]?1:0)*s}}yesNo(e){return parseInt(e,10)<1?"No":"Yes"}isValidDate(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())}id(){return((100*Math.random()).toString()+(100*Math.random()).toString()).replace(/\./g,"")}tryCatch(e,t,i){var s={value:null};try{return e.apply(t,i)}catch(e){return s.value=e,s}}getNumberValue(e){return isNaN(Number(e))?Number(e.substring(0,e.length-2)):e}isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}getOffset(e){e=e.getBoundingClientRect();return{top:e.top+document.body.scrollTop,left:e.left+document.body.scrollLeft}}debounce(s,r,o=!1){let n;return function(){let e=this,t=arguments;var i=o&&!n;clearTimeout(n),n=setTimeout(function(){n=null,o||s.apply(e,t)},r),i&&s.apply(e,t)}}}class Application extends Component{constructor(e){super(),this.options=this._initializeOptions(e),this.name=this.options.name,this.util=new Util,this.log=new LogManager(this),this.constants={},this.log.info("Application initializing...")}_initializeOptions(e){return{auth:{sessionTimeout:e?.auth?.sessionTimeout??9e5},console:e?.console?{enabled:e.console.enabled??!1,wsServer:e.console.wsServer??"",container:e.console.container??("object"==typeof gadgetui?gadgetui.display.FloatingPane:""),top:e.console.top??100,left:e.console.left??500,width:e.console.width??500,height:e.console.height??300}:{},events:e?.events??{},logging:{logLevel:e?.logging?.logLevel??"ERROR,FATAL,INFO",toBrowserConsole:e?.logging?.toBrowserConsole??!1},model:e?.model??"altseven",name:e?.name??"a7",remote:e?.remote?{loginURL:e.remote.loginURL??"",logoutURL:e.remote.logoutURL??"",refreshURL:e.remote.refreshURL??"",useTokens:e?.auth?.useTokens??!0,tokenType:e.remote.tokenType??"X-Token",credentials:e.remote.credentials??"same-origin",modules:e.remote.modules??{}}:{useTokens:!0,credentials:"same-origin"},router:e?.router?{useEvents:e.router.useEvents??!0,routes:e.router.routes}:void 0,security:e?.security?{enabled:e.security.enabled??!0,userArgs:e.security.userArgs??{}}:{enabled:!0,userArgs:{}},services:e?.services??[],ui:{enableMouseTracking:e?.ui?.enableMouseTracking??!1,mouseTrackingDeBounceTime:e?.ui?.mouseTrackingDeBounceTime??100,renderer:e?.ui?.renderer??("object"==typeof Mustache?"Mustache":"object"==typeof Handlebars?"Handlebars":"templateLiterals"),debounceTime:e?.ui?.debounceTime??18,timeout:e?.ui?.timeout??6e5,cacheTemplates:e?.ui?.cacheTemplates??!0},ready:!1}}async init(){if(this.log.trace("application log init"),this.log.trace("application services init"),this.services=new ServiceManager(this),this.log.trace("application dataproviders init"),this.dataproviders=new DataProviderManager(this),this.log.trace("application model init"),this.model=new ModelManager(this),this.model.set(this.options?.applicationName??"a7",this.options),this.options.console.enabled&&(this.log.trace("application console init"),this.console=new Console(this)),this.options.security.enabled&&(this.log.trace("application security init"),this.security=new SecurityManager(this)),this.log.trace("application remote init"),this.remote=new RemoteManager(this),this.log.trace("application events init"),this.events=new EventManager(this),this.options.router&&(this.log.trace("application router init"),this.router=new RouterManager(this)),this.log.trace("application ui init"),this.ui=new UIManager(this),this.options.security.enabled){this.log.trace("application security init"),this.security=new SecurityManager(this),this.error=new ErrorManager(this),0<this.options.services.length&&(this.options.services.forEach(e=>{this.services.register(e)}),this.log.trace("application services registered"));try{var e=await this.security.isAuthenticated();this.log.info(`Authenticated: ${e.authenticated}...`),this.authenticated=e.authenticated,this.user=e.user}catch(e){throw this.log.error("Authentication check failed:",e),e}}return this.log.info("Application initialized..."),this}}export{Component,DataProvider,Entity,Model,Service,User,View,Application};
//# sourceMappingURL=a7.min.js.map